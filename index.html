<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="//img1.wsimg.com/isteam/ip/527d0c41-c926-45df-8daf-d6815ea38b0c/favicon/808bdf2c-2a53-49a6-a0be-016f10978993/66bfdeea-79f7-45a9-881d-ecbc468da3e2.png/:/rs=w:16,h:16,m" sizes="16x16">
    <link rel="icon" href="//img1.wsimg.com/isteam/ip/527d0c41-c926-45df-8daf-d6815ea38b0c/favicon/808bdf2c-2a53-49a6-a0be-016f10978993/66bfdeea-79f7-45a9-881d-ecbc468da3e2.png/:/rs=w:24,h:24,m" sizes="24x24">
    <link rel="icon" href="//img1.wsimg.com/isteam/ip/527d0c41-c926-45df-8daf-d6815ea38b0c/favicon/808bdf2c-2a53-49a6-a0be-016f10978993/66bfdeea-79f7-45a9-881d-ecbc468da3e2.png/:/rs=w:32,h:32,m" sizes="32x32">
    <link rel="icon" href="//img1.wsimg.com/isteam/ip/527d0c41-c926-45df-8daf-d6815ea38b0c/favicon/808bdf2c-2a53-49a6-a0be-016f10978993/66bfdeea-79f7-45a9-881d-ecbc468da3e2.png/:/rs=w:48,h:48,m" sizes="48x48">
    <link rel="icon" href="//img1.wsimg.com/isteam/ip/527d0c41-c926-45df-8daf-d6815ea38b0c/favicon/808bdf2c-2a53-49a6-a0be-016f10978993/66bfdeea-79f7-45a9-881d-ecbc468da3e2.png/:/rs=w:64,h:64,m" sizes="64x64">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DexaBook - Scheduling System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Meta Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '34143226728626532');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=34143226728626532&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
    <style>
        :root {
            --brand-primary: #46A5FC;
            --brand-secondary: #525252;
            --brand-dark: #000000;
            --brand-light: #FFFFFF;
            --brand-primary-dark: #2d8ad9;
            --brand-primary-light: #7ac0fd;
        }

        * {
            font-family: 'Montserrat', sans-serif;
        }
        
        .admin-link {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #999;
            cursor: pointer;
            z-index: 50;
        }
        .admin-link:hover {
            color: #46A5FC;
        }

        body {
            background: var(--brand-light);
            color: var(--brand-dark);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #46A5FC 0%, #2d8ad9 50%, #1a6cb8 100%);
        }

        .gradient-text {
            background: linear-gradient(135deg, #46A5FC 0%, #1a6cb8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(70, 165, 252, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #46A5FC 0%, #2d8ad9 100%);
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(70, 165, 252, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(70, 165, 252, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--brand-light);
            color: var(--brand-secondary);
            border: 2px solid var(--brand-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-secondary:hover {
            background: var(--brand-primary);
            color: white;
        }

        .input-field {
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 4px rgba(70, 165, 252, 0.1);
            outline: none;
        }

        .sidebar-item {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sidebar-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--brand-primary);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .sidebar-item:hover::before,
        .sidebar-item.active::before {
            transform: translateX(0);
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background: rgba(70, 165, 252, 0.1);
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #46A5FC;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 2rem;
        }

        .service-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .service-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .service-card.selected {
            border-color: var(--brand-primary);
            background: linear-gradient(135deg, rgba(70, 165, 252, 0.05) 0%, rgba(70, 165, 252, 0.1) 100%);
        }

        .time-slot {
            transition: all 0.2s ease;
        }

        .time-slot:hover:not(.disabled) {
            background: var(--brand-primary);
            color: white;
            transform: scale(1.02);
        }

        .time-slot.selected {
            background: var(--brand-primary);
            color: white;
        }

        .time-slot.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .slide-up {
            animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .stagger-1 { animation-delay: 0.1s; }
        .stagger-2 { animation-delay: 0.2s; }
        .stagger-3 { animation-delay: 0.3s; }
        .stagger-4 { animation-delay: 0.4s; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            animation: modalSlideIn 0.3s ease forwards;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .progress-step {
            position: relative;
        }

        .progress-step::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 60px;
            height: 2px;
            background: #e5e7eb;
            transform: translateY(-50%);
        }

        .progress-step:last-child::after {
            display: none;
        }

        .progress-step.completed::after {
            background: var(--brand-primary);
        }

        .question-item label {
            display: flex;
            align-items: flex-start; /* Top align text if it wraps */
            gap: 12px;
        }
        
        .checkbox-custom {
            appearance: none;
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            min-width: 24px; /* Prevent shrinking */
            border: 2px solid #616161;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: block;
            background-color: white;
        }
        
        .checkbox-custom:checked {
            background: #46A5FC;
            border-color: #46A5FC;
        }
        
        .checkbox-custom:checked::after {
            content: '';
            position: absolute;
            left: 7px;
            top: 3px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .tab-indicator {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .hero-pattern {
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(70, 165, 252, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(70, 165, 252, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(70, 165, 252, 0.05) 0%, transparent 30%);
        }

        .floating {
            animation: floating 6s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .table-row:hover {
            background: rgba(70, 165, 252, 0.05);
        }

        .status-badge {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--brand-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--brand-primary-dark);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Configuration -->
    <script>
        const CONFIG = {
            // API Keys
            STRIPE_PUBLIC_KEY: 'pk_live_51SvR6q0Is9ppr7DjiGonat9GCoOUfHAHqUp1Q99uHW8dJHgj7yBPiLDSwxSdhamXCrwHOVfcqLFWoTHKcdZtduYy00DkssIZLY',
            GOOGLE_CALENDAR_ID: 'c_071327a59b8b0603d1e4e8eeb609cb2900c589292ae1fdc8087170f6adf0e89b@group.calendar.google.com',
            
            // Google Apps Script Web App URL
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyUCDh4GLd3nHyxh7Mil5Q6HUXJASbUC6ihuWIa_4tyW5j0SXYyFa766Fax31AMqZwfWw/exec',
            
            // Brand colors for JS
            COLORS: {
                primary: '#46A5FC',
                secondary: '#525252',
                dark: '#000000',
                light: '#FFFFFF'
            }
        };
        window.onerror = function(message, source, lineno, colno, error) {
    alert("JavaScript Error: " + message + "\nLine: " + lineno);
    console.error("JS Error:", message, "Line:", lineno);
};
    </script>

    <!-- Main App Container -->
    <div id="app">

        <!-- Customer Booking Flow -->
        <div id="customer-booking" class="min-h-screen">
            <!-- Booking Steps Progress -->
            <div class="bg-white border-b border-gray-100 sticky top-0 z-40">
                <div class="max-w-4xl mx-auto px-6 py-4">
                    <div class="flex items-center justify-between mb-2">
                        <button onclick="goBack()" class="flex items-center gap-2 text-gray-500 hover:text-gray-700 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                            <span class="font-medium">Back</span>
                        </button>
                        <div id="customer-name-display" class="hidden">
                            <span class="text-sm text-gray-500">Welcome back,</span>
                            <span id="welcome-name" class="font-semibold text-gray-900"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-center">
                        <div class="flex items-center gap-4">
                            <div class="progress-step flex items-center gap-2" id="step-1-indicator">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm step-circle bg-blue-500 text-white">1</div>
                                <span class="hidden sm:inline font-medium">Email</span>
                            </div>
                            <div class="w-12 h-0.5 bg-gray-200"></div>
                            <div class="progress-step flex items-center gap-2" id="step-2-indicator">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm step-circle bg-gray-200 text-gray-500">2</div>
                                <span class="hidden sm:inline font-medium text-gray-400">Services</span>
                            </div>
                            <div class="w-12 h-0.5 bg-gray-200"></div>
                            <div class="progress-step flex items-center gap-2" id="step-3-indicator">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm step-circle bg-gray-200 text-gray-500">3</div>
                                <span class="hidden sm:inline font-medium text-gray-400">Schedule</span>
                            </div>
                            <div class="w-12 h-0.5 bg-gray-200"></div>
                            <div class="progress-step flex items-center gap-2" id="step-4-indicator">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm step-circle bg-gray-200 text-gray-500">4</div>
                                <span class="hidden sm:inline font-medium text-gray-400">Details</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Step 1: Email -->
            <div id="booking-step-1" class="step-content py-16 px-6">
                <div class="max-w-xl mx-auto">
                    <div class="text-center mb-6">
                        <img src="https://img1.wsimg.com/isteam/ip/527d0c41-c926-45df-8daf-d6815ea38b0c/blob-e8d8a0e.png/:/cr=t:0%25,l:0%25,w:100%25,h:100%25/rs=w:400,h:100,cg:true" alt="DexaFit KC Logo" class="h-12 inline-block">
                    </div>
                    <div class="text-center mb-10">
                        <h2 class="text-3xl font-black text-gray-900 mb-3">Who? What? When? Done.</h2>
                        <p class="text-gray-600">Enter your email to begin booking!</p>
                    </div>
                    <div class="glass-card rounded-3xl p-8 shadow-xl">
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                            <input type="email" id="customer-email" 
                                   class="input-field w-full px-5 py-4 rounded-xl text-lg" 
                                   placeholder="your@email.com">
                            <p id="email-error" class="text-red-500 text-sm mt-2 hidden">Please enter a valid email address</p>
                        </div>
                        
                        <!-- TURNSTILE WIDGET -->
                        <div class="mb-4 flex justify-center"> 
                            <div class="cf-turnstile" data-sitekey="0x4AAAAAACe7Xzo-HnnSOxBi" data-theme="light" data-size="flexible"></div>
                        </div>
                        
                        <!-- Buttons -->
                        <button onclick="checkEmail()" class="btn-primary w-full py-4 rounded-xl font-bold text-lg mb-3">
                            Book Now
                        </button>
                        
                        <button onclick="showPackagesModal()" class="btn-secondary w-full py-4 rounded-xl font-bold text-lg mb-3">
                            Save with Packages & Memberships
                        </button>

                        <button onclick="showGiftCardModal()" class="btn-secondary w-full py-3 rounded-xl font-semibold text-sm text-gray-500 border-gray-300">
                            Buy Gift Cards
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Services -->
            <div id="booking-step-2" class="step-content py-16 px-6 hidden">
                <div class="max-w-5xl mx-auto">
                    <div class="text-center mb-6">
                        <img src="https://img1.wsimg.com/isteam/ip/527d0c41-c926-45df-8daf-d6815ea38b0c/blob-e8d8a0e.png/:/cr=t:0%25,l:0%25,w:100%25,h:100%25/rs=w:400,h:100,cg:true" alt="DexaFit KC Logo" class="h-12 inline-block">
                    </div>
                    <div class="text-center mb-10">
                        <h2 class="text-3xl font-black text-gray-900 mb-3">Select Your Services</h2>
                        <p class="text-gray-600">Choose from our available services</p>
                    </div>
                    
                    <!-- Credits Display -->
                    <div id="credits-banner" class="hidden mb-8 p-4 rounded-2xl bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-blue-500 flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">You have available credits</p>
                                <p id="credits-detail" class="text-sm text-gray-600"></p>
                            </div>
                        </div>
                    </div>

                    <div id="services-grid" class="grid md:grid-cols-2 gap-6 mb-8">
                        <!-- Services loaded dynamically -->
                    </div>

                    <!-- Order Summary -->
                    <div class="glass-card rounded-2xl p-6 sticky bottom-4 shadow-xl">
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <div>
                                <p class="text-sm text-gray-500">Total Duration</p>
                                <p id="total-duration" class="text-2xl font-bold">0 min</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Estimated Cost</p>
                                <p id="total-price" class="text-2xl font-bold">$0.00</p>
                                <p id="credit-usage-note" class="text-sm text-green-600 hidden"></p>
                            </div>
                            <button onclick="continueToSchedule()" id="continue-schedule-btn" 
                                    class="btn-primary px-8 py-4 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed" 
                                    disabled>
                                Continue to Schedule
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Schedule -->
            <div id="booking-step-3" class="step-content py-16 px-6 hidden">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-6">
                        <img src="https://img1.wsimg.com/isteam/ip/527d0c41-c926-45df-8daf-d6815ea38b0c/blob-e8d8a0e.png/:/cr=t:0%25,l:0%25,w:100%25,h:100%25/rs=w:400,h:100,cg:true" alt="DexaFit KC Logo" class="h-12 inline-block">
                    </div>
                    <div class="text-center mb-10">
                        <h2 class="text-3xl font-black text-gray-900 mb-3">Choose Your Time</h2>
                        <p class="text-gray-600">Select an available slot for your appointment</p>
                    </div>
                    
                    <div class="glass-card rounded-3xl p-8 shadow-xl">
                        <!-- Calendar Navigation -->
                        <div class="flex items-center justify-between mb-6">
                            <button onclick="changeWeek(-1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                </svg>
                            </button>
                            <h3 id="calendar-month" class="text-xl font-bold"></h3>
                            <button onclick="changeWeek(1)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Date Selection -->
                        <div id="date-selector" class="grid grid-cols-7 gap-2 mb-8">
                            <!-- Dates populated dynamically -->
                        </div>

                        <!-- Time Slots -->
                        <div id="time-slots-container" class="hidden">
                            <h4 class="font-semibold mb-4 text-gray-700">Available Times</h4>
                            <div id="time-slots" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                                <!-- Time slots populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-center sm:justify-end mt-8">
                        <button onclick="continueToDetails()" id="continue-details-btn" 
                                class="btn-primary px-8 py-4 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed" 
                                disabled>
                            Finalize Booking
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Questions & Details -->
            <div id="booking-step-4" class="step-content py-16 px-6 hidden">
                <div class="max-w-2xl mx-auto">
                    <div class="text-center mb-6">
                        <img src="https://img1.wsimg.com/isteam/ip/527d0c41-c926-45df-8daf-d6815ea38b0c/blob-e8d8a0e.png/:/cr=t:0%25,l:0%25,w:100%25,h:100%25/rs=w:400,h:100,cg:true" alt="DexaFit KC Logo" class="h-12 inline-block">
                    </div>
                    <div class="text-center mb-10">
                        <h2 class="text-3xl font-black text-gray-900 mb-3">Almost There</h2>
                        <p class="text-gray-600">Just a few more details</p>
                    </div>
            
                    <div class="glass-card rounded-3xl p-8 shadow-xl">
                        <form id="booking-details-form" onsubmit="submitBooking(event)">
                            <!-- Dynamic Height/Weight Section -->
                            <div id="hw-section" class="mb-6 p-4 bg-gray-50 rounded-xl">
                                <p class="font-semibold mb-3">Have your height or weight changed since your last visit?</p>
                                <div class="flex gap-4 mb-3">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="hw-changed" value="no" checked class="form-radio" onchange="toggleHWFields(false)">
                                        <span>No</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="hw-changed" value="yes" class="form-radio" onchange="toggleHWFields(true)">
                                        <span>Yes</span>
                                    </label>
                                </div>
                                <div id="hw-fields" class="hidden grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Height</label>
                                        <input type="text" name="height" id="input-height" class="input-field w-full px-4 py-3 rounded-xl" placeholder="e.g., 5'10">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Estimate Weight (lbs)</label>
                                        <input type="number" name="weight" id="input-weight" class="input-field w-full px-4 py-3 rounded-xl" placeholder="e.g., 160">
                                    </div>
                                </div>
                            </div>
            
                            <!-- New Customer Fields -->
                            <div id="new-customer-fields" class="hidden mb-6 pt-6 border-t border-gray-200">
                                <h4 class="font-bold text-lg mb-4">Account Information</h4>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
                                        <input type="text" name="fullName" id="input-fullName" class="input-field w-full px-4 py-3 rounded-xl" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Phone Number *</label>
                                        <input type="tel" name="phone" id="input-phone" class="input-field w-full px-4 py-3 rounded-xl" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Date of Birth *</label>
                                        <input type="date" name="dob" id="input-dob" class="input-field w-full px-4 py-3 rounded-xl" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Sex *</label>
                                        <select name="sex" id="input-sex" class="input-field w-full px-4 py-3 rounded-xl" required>
                                            <option value="">Select...</option>
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Height *</label>
                                        <input type="text" name="heightNew" id="input-height-new" class="input-field w-full px-4 py-3 rounded-xl" placeholder="e.g., 5'10" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Weight (lbs) *</label>
                                        <input type="number" name="weightNew" id="input-weight-new" class="input-field w-full px-4 py-3 rounded-xl" required>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Ethnicity *</label>
                                        <input type="text" name="ethnicity" id="input-ethnicity" class="input-field w-full px-4 py-3 rounded-xl" placeholder="Required for accurate comps/norms" required>
                                    </div>
                                </div>
                            </div>
            
                            <!-- Dynamic Questions Container -->
                            <div id="questions-container" class="space-y-6 mb-6">
                                <!-- Questions populated dynamically -->
                            </div>
            
                            <p class="text-sm text-gray-500 mb-4">
                                Promo codes and gift cards can be applied at checkout
                            </p>
            
                            <button type="submit" class="btn-primary w-full py-4 rounded-xl font-bold text-lg">
                                Complete Booking
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Business Portal -->
        <div id="business-portal" class="min-h-screen hidden">
            <div class="flex">
                <!-- Sidebar -->
                <aside class="w-64 bg-white border-r border-gray-100 min-h-screen fixed left-0 top-0 z-50">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 rounded-xl gradient-bg flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <span class="text-xl font-bold text-gray-900">DexaBook</span>
                        </div>
                    </div>
                    <nav class="p-4">
                        <ul class="space-y-1">
                            <li>
                                <button onclick="showBusinessSection('credits')" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3" data-section="credits">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                                    Credit Mgmt
                                </button>
                            </li>
                            <li>
                                <button onclick="showBusinessSection('calendar')" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3" data-section="calendar">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    Calendar
                                </button>
                            </li>
                            <li>
                                <button onclick="showBusinessSection('customers')" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3" data-section="customers">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                    Customers
                                </button>
                            </li>
                            <li>
                                <button onclick="showBusinessSection('bookings')" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3" data-section="bookings">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                    </svg>
                                    Appointments
                                </button>
                            </li>
                            <li>
                                <button onclick="showBusinessSection('checkout')" class="sidebar-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3" data-section="checkout">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    </svg>
                                    Checkout
                                </button>
                            </li>
                        </ul>
                    </nav>
                    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-100">
                        <button onclick="backToBooking()" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-gray-500 hover:bg-gray-50 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            Exit Portal
                        </button>
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="flex-1 ml-64 min-h-screen bg-gray-50">
                                        <!-- Credit Management Section -->
                    <div id="section-credits" class="business-section p-8 hidden">
                        <div class="mb-8 flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-black text-gray-900">Credit Management</h1>
                                <p class="text-gray-600">Manage service credits and gift cards</p>
                            </div>
                            <button onclick="openAddCreditModal()" class="btn-primary px-6 py-3 rounded-xl font-semibold inline-flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                Add Credit/GC
                            </button>
                        </div>
                        <div class="glass-card rounded-2xl p-6 mb-6">
                            <div class="relative">
                                <input type="text" id="credit-search" placeholder="Search by name, email..." class="input-field w-full pl-12 pr-4 py-3 rounded-xl" oninput="debounceSearchCredits(this.value)">
                                <svg class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            </div>
                        </div>
                        <div id="credits-list-container" class="glass-card rounded-2xl overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b border-gray-100">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Customer</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Type</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Value</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Expiration</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Status</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="credits-table-body">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Calendar Section -->
                    <div id="section-calendar" class="business-section p-8 hidden">
                        <div class="mb-8 flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-black text-gray-900">Calendar</h1>
                                <p class="text-gray-600">Manage your appointments</p>
                            </div>
                            <a href="https://calendar.google.com" target="_blank" 
                               class="btn-primary px-6 py-3 rounded-xl font-semibold inline-flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                </svg>
                                Open Google Calendar
                            </a>
                        </div>
                        <div class="glass-card rounded-2xl p-6">
                            <div id="business-calendar" class="min-h-96">
                                <!-- Calendar view -->
                            </div>
                        </div>
                    </div>

                    <!-- Customers Section -->
                    <div id="section-customers" class="business-section p-8 hidden">
                        <div class="mb-8 flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-black text-gray-900">Customers</h1>
                                <p class="text-gray-600">Manage customer accounts</p>
                            </div>
                            <button onclick="openCustomerModal()" class="btn-primary px-6 py-3 rounded-xl font-semibold inline-flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                                </svg>
                                Add Customer
                            </button>
                        </div>
                        <div class="glass-card rounded-2xl p-6 mb-6">
                            <div class="relative">
                                <input type="text" id="customer-search" placeholder="Search by name, email, or phone..." 
                                   class="input-field w-full pl-12 pr-4 py-3 rounded-xl"
                                   oninput="debounceSearchCustomers(this.value)">
                                <svg class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                        </div>
                        <div id="customers-list" class="glass-card rounded-2xl overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b border-gray-100">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Name</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Email</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Phone</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Notes</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Actions</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Book</th>
                                    </tr>
                                </thead>
                                <tbody id="customers-table-body">
                                    <!-- Customers populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Appointments Section (Consolidated) -->
                    <div id="section-bookings" class="business-section p-8 hidden">
                        <div class="mb-8 flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-black text-gray-900">Appointments</h1>
                                <p class="text-gray-600" id="bookings-date-display"></p>
                            </div>
                            <div class="flex items-center gap-4">
                                <input type="date" id="bookings-date" class="input-field px-4 py-2 rounded-xl" onchange="loadAppointmentsForDate(this.value)">
                            </div>
                        </div>
                        <div id="bookings-list" class="space-y-4">
                            <!-- Bookings populated dynamically -->
                        </div>
                    </div>
                    
                    <!-- Checkout Section -->
                    <div id="section-checkout" class="business-section p-8 hidden">
                        <div class="mb-8 flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-black text-gray-900">Checkout</h1>
                                <p class="text-gray-600">Process payments and complete appointments</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <input type="date" id="checkout-date" class="input-field px-4 py-2 rounded-xl" onchange="loadCheckoutAppointments(this.value)">
                            </div>
                        </div>
                        
                        <div class="grid lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2">
                                <div class="glass-card rounded-2xl p-6">
                                    <h3 class="font-bold text-lg mb-4">Appointments</h3>
                                    <div id="checkout-appointments" class="space-y-3">
                                        <!-- Appointments populated dynamically -->
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="glass-card rounded-2xl p-6 sticky top-8">
                                    <h3 class="font-bold text-lg mb-4">Summary</h3>
                                    <div id="checkout-summary" class="space-y-3 mb-6">
                                        <p class="text-gray-500 text-sm">Select appointments to checkout</p>
                                    </div>
                                    <div class="border-t border-gray-200 pt-4">
                                        <div class="flex justify-between mb-2">
                                            <span class="text-gray-600">Subtotal</span>
                                            <span id="checkout-subtotal" class="font-semibold">$0.00</span>
                                        </div>
                                        <div class="flex justify-between text-lg font-bold">
                                            <span>Total</span>
                                            <span id="checkout-total">$0.00</span>
                                        </div>
                                    </div>
                                    <button onclick="initiateCheckout()" id="checkout-btn" class="btn-primary w-full py-3 rounded-xl font-bold mt-4 disabled:opacity-50" disabled>
                                        Continue
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Success Page -->
        <div id="success-page" class="min-h-screen hidden flex items-center justify-center hero-pattern">
            <div class="text-center max-w-lg px-6">
                <div class="w-24 h-24 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-8">
                    <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h1 class="text-4xl font-black text-gray-900 mb-4">Booking Confirmed</h1>
                <p class="text-xl text-gray-600 mb-8">Your appointment has been successfully scheduled. You'll receive a confirmation email shortly.</p>
                <div class="glass-card rounded-2xl p-6 text-left mb-8">
                    <h3 class="font-bold mb-4">Appointment Details</h3>
                    <div id="success-details" class="space-y-2 text-gray-600">
                        <!-- Details populated dynamically -->
                    </div>
                </div>
                <button onclick="backToBooking()" class="btn-primary px-8 py-4 rounded-xl font-bold">
                    Return Home
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
        <!-- Packages Modal -->
    <div id="packages-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closePackagesModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content glass-card rounded-3xl p-8 w-full max-w-3xl relative z-10 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Packages & Memberships</h2>
                    <button onclick="closePackagesModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>

                <!-- Toggle -->
                <div class="flex justify-center mb-6">
                    <div class="bg-gray-100 rounded-xl p-1 inline-flex">
                        <button id="btn-toggle-packages" onclick="togglePkgView('packages')" class="px-6 py-2 rounded-lg font-semibold text-sm bg-white shadow">Packages</button>
                        <button id="btn-toggle-memberships" onclick="togglePkgView('memberships')" class="px-6 py-2 rounded-lg font-semibold text-sm text-gray-500">Memberships</button>
                    </div>
                </div>

                <!-- Manage Memberships Link (Hidden for Packages) -->
                <div id="manage-membership-link" class="hidden text-center mb-4">
                    <a href="#" onclick="goToPortal()" class="text-blue-600 hover:underline text-sm">Manage my existing memberships</a>
                </div>

                <!-- List Container -->
                <div id="packages-list-container" class="space-y-4">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Appointment Modal -->
    <div id="edit-appt-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeEditApptModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content glass-card rounded-3xl p-8 w-full max-w-lg relative z-10 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Edit Appointment</h2>
                    <button onclick="closeEditApptModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                
                <input type="hidden" id="edit-appt-email">
                <input type="hidden" id="edit-appt-old-title">
                <input type="hidden" id="edit-appt-old-time">
                
                <!-- Date/Time -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Date</label>
                        <input type="date" id="edit-appt-date" class="input-field w-full px-4 py-3 rounded-xl">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Time</label>
                        <input type="time" id="edit-appt-time" class="input-field w-full px-4 py-3 rounded-xl">
                    </div>
                </div>
                
                <!-- Services -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-2">Services</label>
                    <div id="edit-appt-services" class="space-y-2">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                
                <!-- Price Estimate -->
                <div class="mb-6 p-3 bg-blue-50 rounded-xl">
                    <div class="flex justify-between">
                        <span class="font-semibold">Estimated Price:</span>
                        <span id="edit-appt-price" class="font-bold text-blue-600">$0.00</span>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="cancelAppointment()" class="py-3 px-4 rounded-xl font-semibold text-red-600 border-2 border-red-300 hover:bg-red-50 flex-1">Cancel Appointment</button>
                    <button onclick="saveAppointmentEdit()" class="btn-primary flex-1 py-3 rounded-xl font-semibold">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gift Card Modal -->
    <div id="giftcard-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeGiftCardModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content glass-card rounded-3xl p-8 w-full max-w-md relative z-10">
                
                <!-- Back Button for Direct Links -->
                <button onclick="closeGiftCardModal()" class="text-sm text-gray-500 mb-4 flex items-center gap-1 hover:text-gray-700">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    Back to Booking
                </button>

                <h2 class="text-2xl font-bold mb-2">Buy Gift Card</h2>
                <p class="text-xs text-gray-500 mb-6">Gift cards are valid for 1 year from purchase date.</p>
                
                <!-- Buyer Email (Shown if coming from direct link) -->
                <div id="gc-buyer-email-container" class="mb-4 hidden">
                    <label class="block text-sm font-semibold mb-2">Your Email</label>
                    <input type="email" id="gc-buyer-email-input" class="input-field w-full px-4 py-3 rounded-xl" placeholder="you@example.com">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-2">Amount ($)</label>
                    <input type="number" id="gc-amount-input-modal" class="input-field w-full px-4 py-3 rounded-xl" placeholder="50.00">
                </div>

                <!-- Is this a gift? -->
                <div class="mb-4 p-4 bg-gray-50 rounded-xl">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="gc-is-gift" class="checkbox-custom" onchange="document.getElementById('gc-recipient-fields').classList.toggle('hidden', !this.checked)">
                        <span class="font-medium">This is a gift for someone else</span>
                    </label>
                </div>

                <div id="gc-recipient-fields" class="hidden mb-4 space-y-3">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Recipient Name</label>
                        <input type="text" id="gc-recipient-name" class="input-field w-full px-4 py-3 rounded-xl" placeholder="Jane Doe">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Recipient Email</label>
                        <input type="email" id="gc-recipient-email" class="input-field w-full px-4 py-3 rounded-xl" placeholder="jane@example.com">
                    </div>
                </div>

                <button onclick="purchaseGiftCard()" class="btn-primary w-full py-3 rounded-xl font-bold">Continue to Payment</button>
            </div>
        </div>
    </div>
    <!-- Add Credit Modal -->
    <div id="add-credit-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeAddCreditModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content glass-card rounded-3xl p-8 w-full max-w-md relative z-10">
                <h2 class="text-2xl font-bold mb-6">Add Credit / Gift Card</h2>
                <form onsubmit="submitNewCredit(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Customer Email</label>
                        <input type="email" id="new-cred-email" class="input-field w-full px-4 py-2 rounded-lg" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Customer Name</label>
                        <input type="text" id="new-cred-name" class="input-field w-full px-4 py-2 rounded-lg" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Item / Service</label>
                        <select id="new-cred-item" class="input-field w-full px-4 py-2 rounded-lg" required>
                            <option value="gc">Gift Card (GC)</option>
                            <!-- Populated dynamically by JS -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Value ($ or Quantity)</label>
                        <input type="number" id="new-cred-value" class="input-field w-full px-4 py-2 rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-2">Expiration (Optional)</label>
                        <input type="date" id="new-cred-exp" class="input-field w-full px-4 py-2 rounded-lg">
                    </div>
                    <div class="flex gap-4">
                        <button type="button" onclick="closeAddCreditModal()" class="btn-secondary flex-1 py-3 rounded-xl font-semibold">Cancel</button>
                        <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-semibold">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Checkout Process Modal -->
    <div id="checkout-process-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeCheckoutModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content glass-card rounded-3xl p-8 w-full max-w-2xl relative z-10 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Finalize Checkout</h2>
                    <button onclick="closeCheckoutModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                
                <!-- Payer Name -->
                <div class="mb-6 p-4 bg-blue-50 rounded-xl text-center">
                    <p class="text-sm text-gray-500">Payer</p>
                    <h3 id="checkout-payer-name" class="text-xl font-bold text-blue-800"></h3>
                </div>

                <!-- Crediting Customer (for shared credits) -->
                <div class="mb-6 p-4 border border-purple-200 rounded-xl bg-purple-50">
                    <h4 class="font-bold mb-2 text-purple-800">Apply Credits From Another Customer</h4>
                    <p class="text-xs text-gray-500 mb-3">If someone else's credits should be applied, search for them here.</p>
                    <div class="flex gap-2">
                        <input type="email" id="crediting-customer-email" class="input-field flex-1 px-3 py-2 rounded-lg text-sm" placeholder="Credit holder's email...">
                        <button onclick="addCreditingCustomer()" class="btn-secondary px-4 py-2 rounded-lg text-sm font-semibold">Add</button>
                    </div>
                    <div id="crediting-customer-list" class="mt-2 space-y-1">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Service List & Credits -->
                <div class="mb-6">
                    <h4 class="font-bold mb-3">Services & Credits</h4>
                    <p class="text-xs text-gray-500 mb-2">Credits from any person can be applied to any service.</p>
                    <div id="checkout-service-list" class="space-y-4">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Gift Card Section (Dynamic) -->
                <div class="mb-6 p-4 border border-gray-200 rounded-xl">
                    <h4 class="font-bold mb-3">Gift Card Usage</h4>
                    <div id="gc-inputs-container" class="space-y-2">
                        <!-- Populated by JS -->
                    </div>
                    <p id="gc-error-text" class="text-xs text-red-500 mt-2 hidden">Amount exceeds available balance.</p>
                </div>

                <!-- Discount Search -->
                <div class="mb-6 p-4 border border-gray-200 rounded-xl">
                    <h4 class="font-bold mb-2">Discount</h4>
                    <div class="relative">
                        <input type="text" id="modal-discount-search" class="input-field w-full px-3 py-2 rounded-lg text-sm" placeholder="Search discounts..." oninput="filterModalDiscounts(this.value)" onfocus="showModalDiscountList()">
                        <input type="hidden" id="modal-discount-id">
                        <div id="modal-discount-list" class="absolute z-20 w-full bg-white border border-gray-200 rounded-lg mt-1 shadow-lg hidden max-h-48 overflow-y-auto"></div>
                    </div>
                    <div id="modal-applied-discount" class="hidden mt-2 p-2 bg-green-50 text-green-700 rounded-lg text-sm flex justify-between items-center">
                        <span id="modal-applied-text"></span>
                        <button onclick="clearModalDiscount()" class="text-red-500 hover:text-red-700 font-bold text-xs">Remove</button>
                    </div>
                </div>

                <!-- Notes (Changed to Textarea) -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-2">Notes</label>
                    <textarea id="checkout-notes-input" class="input-field w-full px-3 py-2 rounded-lg text-sm" rows="4" placeholder="Additional notes..."></textarea>
                </div>

                <!-- Totals & Manual Override -->
                <div class="border-t border-gray-200 pt-4 mb-6">
                    <div class="flex justify-between mb-2"><span>Original Total</span><span id="co-original"></span></div>
                    <div class="flex justify-between mb-2 text-green-600"><span>Bundle Savings</span><span id="co-bundle-savings"></span></div>
                    <div class="flex justify-between mb-2 text-purple-600"><span>Credit Savings</span><span id="co-credit-savings"></span></div>
                    <div class="flex justify-between mb-2 text-orange-600"><span>Gift Card</span><span id="co-gc-savings"></span></div>
                    <div class="flex justify-between mb-2 text-blue-600"><span>Discount</span><span id="co-discount-savings"></span></div>
                    
                    <div class="flex justify-between font-bold text-lg mt-2 pt-2 border-t items-center">
                        <span>Total Charge</span>
                        <div class="flex items-center gap-2">
                            <span id="co-final-total" class="text-blue-600"></span>
                            <!-- Manual Override Icon -->
                            <button onclick="toggleModalOverride()" class="text-gray-400 hover:text-blue-500 p-1" title="Adjust Price">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Manual Override Input -->
                    <div id="modal-override-container" class="hidden mt-2 bg-yellow-50 p-2 rounded-lg border border-yellow-200">
                        <label class="text-xs font-semibold text-yellow-800">Manual Override ($)</label>
                        <input type="number" id="modal-override-input" class="input-field w-full px-2 py-1 rounded text-sm" placeholder="Enter new total" oninput="applyModalOverride(this.value)">
                    </div>
                </div>

                <button onclick="acceptPayment()" class="btn-primary w-full py-3 rounded-xl font-bold mt-2">Accept Payment (Stripe)</button>
                <button id="accept-cash-btn" onclick="acceptCash()" class="btn-secondary w-full py-3 rounded-xl font-bold mt-2 border border-green-500 text-green-600 hover:bg-green-50">Accept Cash</button>
            </div>
        </div>
    </div>
    <!-- Service Modal -->
    <div id="service-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeServiceModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content glass-card rounded-3xl p-8 w-full max-w-2xl relative z-10 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="service-modal-title" class="text-2xl font-bold">Add Service</h2>
                    <button onclick="closeServiceModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <form id="service-form" onsubmit="saveService(event)">
                    <input type="hidden" id="service-id">
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Service Name *</label>
                            <input type="text" id="service-name" class="input-field w-full px-4 py-3 rounded-xl" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Duration (minutes) *</label>
                            <input type="number" id="service-duration" class="input-field w-full px-4 py-3 rounded-xl" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                        <textarea id="service-description" class="input-field w-full px-4 py-3 rounded-xl" rows="3"></textarea>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Price ($) *</label>
                            <input type="number" step="0.01" id="service-price" class="input-field w-full px-4 py-3 rounded-xl" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Add-on Price ($)</label>
                            <input type="number" step="0.01" id="service-addon-price" class="input-field w-full px-4 py-3 rounded-xl">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Add-on Duration (minutes)</label>
                        <input type="number" id="service-addon-duration" class="input-field w-full px-4 py-3 rounded-xl">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Excluded Questions (comma-separated IDs)</label>
                        <input type="text" id="service-excluded-questions" class="input-field w-full px-4 py-3 rounded-xl" placeholder="e.g., 1,3,5">
                    </div>
                    <div class="flex gap-4">
                        <button type="button" onclick="closeServiceModal()" class="btn-secondary flex-1 py-3 rounded-xl font-semibold">Cancel</button>
                        <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-semibold">Save Service</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customer-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeCustomerModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content glass-card rounded-3xl p-8 w-full max-w-3xl relative z-10 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="customer-modal-title" class="text-2xl font-bold">Add Customer</h2>
                    <button onclick="closeCustomerModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <form id="customer-form" onsubmit="saveCustomer(event)">
                    <input type="hidden" id="edit-customer-id">
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
                            <input type="text" id="edit-fullName" class="input-field w-full px-4 py-3 rounded-xl" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                            <input type="email" id="edit-email" class="input-field w-full px-4 py-3 rounded-xl" required>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Phone</label>
                            <input type="tel" id="edit-phone" class="input-field w-full px-4 py-3 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Date of Birth</label>
                            <input type="date" id="edit-dob" class="input-field w-full px-4 py-3 rounded-xl">
                        </div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Sex</label>
                            <select id="edit-sex" class="input-field w-full px-4 py-3 rounded-xl">
                                <option value="">Select...</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Height</label>
                            <input type="text" id="edit-height" class="input-field w-full px-4 py-3 rounded-xl" placeholder="e.g., 5'10&quot;">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Weight (lbs)</label>
                            <input type="number" id="edit-weight" class="input-field w-full px-4 py-3 rounded-xl">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Ethnicity</label>
                        <input type="text" id="edit-ethnicity" class="input-field w-full px-4 py-3 rounded-xl">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
                        <textarea id="edit-notes" class="input-field w-full px-4 py-3 rounded-xl" rows="3"></textarea>
                    </div>
                    
                    <!-- Customer History -->
                    <div id="customer-history" class="hidden mb-6 p-4 bg-gray-50 rounded-xl">
                        <h4 class="font-bold mb-3">Appointment History</h4>
                        <div id="customer-appointments" class="space-y-2">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <div class="text-xs text-gray-600 mb-6 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                        <h4 class="font-bold text-yellow-800 mb-2">Phone Booking Reminders:</h4>
                        <ul class="list-disc list-inside space-y-1">
                            <li>Confirm the client is <strong>not pregnant</strong>, is <strong>under 350 lbs</strong>, and will <strong>not have contrast injected</strong> in the 7 before testing.</li>
                            <li>Mention that our protocols and waiver/terms are in the booking confirmation email and calendar. By attending the appointment, the customer is agreeing to those.</li>
                            <li>Remember to mention the <strong>cancellation policy</strong>.</li>
                        </ul>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="button" onclick="closeCustomerModal()" class="btn-secondary flex-1 py-3 rounded-xl font-semibold">Cancel</button>
                        <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-semibold">Save Customer</button>
                        <button type="button" onclick="saveAndBook()" class="py-3 px-4 rounded-xl font-semibold text-white" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); box-shadow: 0 4px 15px rgba(34,197,94,0.3);">Save & Book</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Question Change Modal -->
    <div id="question-change-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeQuestionChangeModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content glass-card rounded-3xl p-8 w-full max-w-md relative z-10">
                <h2 class="text-xl font-bold mb-4">Has this changed?</h2>
                <p id="question-change-text" class="text-gray-600 mb-6"></p>
                <div class="flex gap-4">
                    <button onclick="answerQuestionChange(false)" class="btn-secondary flex-1 py-3 rounded-xl font-semibold">No, skip</button>
                    <button onclick="answerQuestionChange(true)" class="btn-primary flex-1 py-3 rounded-xl font-semibold">Yes, update</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Question Modal -->
    <div id="question-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeQuestionModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content glass-card rounded-3xl p-8 w-full max-w-lg relative z-10">
                <h2 id="question-modal-title" class="text-2xl font-bold mb-6">Add Question</h2>
                <form id="question-form" onsubmit="saveQuestionData(event)">
                    <input type="hidden" id="question-id">
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Question Text</label>
                        <input type="text" id="question-text" class="input-field w-full px-4 py-3 rounded-xl" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Type</label>
                            <select id="question-type" class="input-field w-full px-4 py-3 rounded-xl">
                                <option value="short text">Short Text</option>
                                <option value="long text">Long Text</option>
                                <option value="checkbox">Checkbox</option>
                                <option value="number">Number</option>
                                <option value="date">Date</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Ask Frequency</label>
                            <select id="question-ask" class="input-field w-full px-4 py-3 rounded-xl">
                                <option value="every time">Every Time</option>
                                <option value="once">Once</option>
                                <option value="if has changed">If Has Changed</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="question-required" class="checkbox-custom">
                            <span class="font-medium">Required</span>
                        </label>
                    </div>
                    <div class="flex gap-4">
                        <button type="button" onclick="closeQuestionModal()" class="btn-secondary flex-1 py-3 rounded-xl font-semibold">Cancel</button>
                        <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-semibold">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content glass-card rounded-3xl p-8 w-full max-w-md relative z-10">
                <h2 class="text-2xl font-bold mb-6">Business Portal Login</h2>
                <form onsubmit="handlePasswordSubmit(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2">Password</label>
                        <input type="password" id="business-password" class="input-field w-full px-4 py-3 rounded-xl" required>
                        <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Incorrect password.</p>
                    </div>
                    
                    <!-- TURNSTILE WIDGET -->
                    <div class="cf-turnstile mb-4" data-sitekey="0x4AAAAAACe7Xzo-HnnSOxBi" data-theme="light"></div>
                    
                    <div class="flex gap-4">
                        <button type="button" onclick="closePasswordModal()" class="btn-secondary flex-1 py-3 rounded-xl font-semibold">Cancel</button>
                        <button type="submit" class="btn-primary flex-1 py-3 rounded-xl font-semibold">Login</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Payment Payer Selection Modal -->
    <div id="payer-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closePayerModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content glass-card rounded-3xl p-8 w-full max-w-md relative z-10">
                <h2 class="text-xl font-bold mb-4">Who is paying?</h2>
                <p class="text-gray-600 mb-6">Multiple customers are being checked out. Please select who will handle payment.</p>
                <div id="payer-options" class="space-y-3 mb-6">
                    <!-- Populated dynamically -->
                </div>
                <div class="flex gap-4">
                    <button onclick="closePayerModal()" class="btn-secondary flex-1 py-3 rounded-xl font-semibold">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let currentAdminPassword = null;
        const CLASS_A_IDS = ['1', '2', '3'];
        const HARDCODED_SERVICES = [
            { id: '1', name: 'DEXA Body Composition Scan', description: 'DEXA (or DXA) scans are the Gold Standard for body composition trusted by research & elite sports labs. FDA-approved technology uses low-dose radiation for body fat percentage (not BMI), total mass, lean tissue mass, bone mineral content (BMC), visceral fat mass, lean tissue mass symmetry, total body bone mineral density (BMD), plus.', duration: 15, price: 149, addonPrice: 139, addonDuration: 15, excludedQuestions: '' },
            { id: '2', name: 'RMR Resting Metabolic Rate | Fasted Test', description: 'RMR (gas exchange) represents the amount of calories you need to maintain essential functions at rest (things like heartbeat and breathing). Pinpointing the precise number of calories you burn at rest is crucial if you are trying to lose weight or build lean mass. The RMR test will analyze how efficient your body is at converting food to energy, whether you use more fat or sugar as fuel, & if you have a slowed metabolism.', duration: 20, price: 125, addonPrice: 115, addonDuration: 15, excludedQuestions: '1,5,6' },
            { id: '3', name: 'VO2 Max Treadmill Test', description: 'The VO2 Max test pinpoints your precise fitness capacity, pure endurance potential, and cardiovascular degeneration. Learn yours if you want to exercise smarter and avoid overtraining. Proper training at your VO2max improves your bodys power grid. It strengthens your heart, improves blood flow and metabolism, and makes your muscles more efficient. VO2max is a more reliable health and longevity indicator than many other factors.', duration: 30, price: 135, addonPrice: 125, addonDuration: 25, excludedQuestions: '1,5,6' },
            { id: '4', name: 'Styku 3D Body Scan', description: 'This scan is a 3D imager and NOT a DXA scan. We show you how to run the test, and you setup a profile. Scan is emailed to you as a PDF link from Styku. Wear tight fitting clothing with hair up for most accurate results. See yourself in 3D with measurements from neck to calves.', duration: 5, price: 35, addonPrice: 10, addonDuration: 5, excludedQuestions: '1,5,6' },
            { id: '5', name: 'Grip Strength Evaluation', description: 'Grip strength is a vital marker of overall health and longevity. A Handgrip Strength Test measures your muscle strength, tracks your progress, and supports your fitness goals. Research indicates that a 5-kilogram decline in grip strength corresponds to a 16% increase in the risk of death within four years.', duration: 5, price: 15, addonPrice: 10, addonDuration: 5, excludedQuestions: '1,5,6' },
            { id: '6', name: 'Data Review/Consultation', description: 'If you would like us to go over your test results with you for free, select this option! If not testing, a $20 fee is assesed to discuss results, goals, and next steps.', duration: 30, price: 20, addonPrice: 0, addonDuration: 15, excludedQuestions: '1,3,5,6' }
        ];
        
        const HARDCODED_QUESTIONS = [
            { id: '5', type: 'short text', required: false, text: 'Briefly list any joint replacements (optional)', ask: 'every time' },
            { id: '6', type: 'checkbox', required: false, text: 'Check if you have hearing aids (optional)', ask: 'every time' },
            { id: '1', type: 'checkbox', required: true, text: 'I am not pregnant, do not suspect I may be pregnant, and am not attempting to become pregnant. My weight does not exceed 350 pounds. I have not been administered gastrointestinal contrast or radionuclide agents within the previous 7 days.', ask: 'every time' },
            { id: '2', type: 'checkbox', required: true, text: 'I have read the [waiver and consent form](https://dexafitkc.com/documents) and do consent to participate in the services rendered by QFit LLC dba DexaFit KC and/or DexaFit, LLC.', ask: 'every time' },
            { id: '3', type: 'checkbox', required: true, text: 'I have fully read the [protocols page](https://dexafitkc.com/protocols) will properly prepare for my appointments.', ask: 'every time' },
            { id: '4', type: 'long text', required: false, text: 'Additional Notes:', ask: 'every time' }
        ];

        const state = {
            currentStep: 1,
            customerEmail: '',
            existingCustomer: null,
            selectedServices: [],
            selectedDate: null,
            selectedTime: null,
            currentWeekStart: new Date(),
            totalDuration: 0,
            totalPrice: 0,
            credits: [],
            giftCards: [],
            questions: [],
            questionAnswers: {},
            pendingQuestionChange: null,
            checkoutSelected: [],
            appliedDiscount: null,
            services: [],
            customers: [],
            bookings: [],
            customerSearch: '',
            creditSearch: ''
        };

        // Sample data for demo (in production, this comes from Google Sheets)
        const sampleServices = [
            { id: '1', name: 'Initial Consultation', description: 'Comprehensive health assessment and goal setting session', duration: 60, price: 150, addonPrice: 120, addonDuration: 45, excludedQuestions: '' },
        ];

        const sampleQuestions = [
            { id: '1', type: 'short text', required: true, text: 'What are your primary health goals?', ask: 'every time' },
            { id: '2', type: 'checkbox', required: false, text: 'I agree to the terms and conditions: https://example.com/terms', ask: 'once' },
            { id: '3', type: 'long text', required: false, text: 'Please describe any current symptoms or concerns', ask: 'every time' },
            { id: '4', type: 'number', required: true, text: 'Current weight (lbs)', ask: 'if has changed' },
            { id: '5', type: 'date', required: false, text: 'Date of last physical exam', ask: 'once' },
            { id: '6', type: 'short text', required: false, text: 'List any join replacements', ask: 'every time' },
            { id: '7', type: 'checkbox', required: false, text: 'I have hearing aids', ask: 'every time' }
        ];

        const sampleCustomers = [
            { id: '1', email: 'emily@example.com', fullName: 'Emily Davis', phone: '555-0103', sex: 'female', dob: '1988-11-08', height: '5\'4"', weight: '130', ethnicity: 'Hispanic', notes: 'Allergic to latex' }
        ];

        const sampleCredits = [
            { id: '1', customerEmail: 'emily@example.com', name: 'Initial Consultation', value: 2, expiration: '2025-12-31', used: 0 },
        ];

        // ============================================
        // NAVIGATION
        // ============================================
        function showCustomerBooking() {
            document.getElementById('business-portal').classList.add('hidden');
            document.getElementById('customer-booking').classList.remove('hidden');
            state.currentStep = 1;
            updateStepIndicators();
        }

        function showBusinessLogin() {
            // Show Password Modal instead of going straight to portal
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('business-password').value = '';
            document.getElementById('password-error').classList.add('hidden');
        }
        
        function closePasswordModal() {
            document.getElementById('password-modal').classList.add('hidden');
        }
        
        async function handlePasswordSubmit(e) {
            e.preventDefault();
            const password = document.getElementById('business-password').value;
            
            // Check Turnstile
            const turnstileResponse = document.querySelector('#password-modal [name="cf-turnstile-response"]');
            if (!turnstileResponse || !turnstileResponse.value) {
                document.getElementById('password-error').textContent = "Please complete the security check.";
                document.getElementById('password-error').classList.remove('hidden');
                return;
            }
            
            
        
            try {
                const response = await callAppsScript('checkPassword', { password: password }); // Will send password because action is 'checkPassword'
                
                if (response.valid) {
                    currentAdminPassword = password;
                    closePasswordModal();
                    document.getElementById('customer-booking').classList.add('hidden');
                    document.getElementById('business-portal').classList.remove('hidden');
                    showBusinessSection('bookings');
                } else {
                    document.getElementById('password-error').textContent = "Incorrect password.";
                    document.getElementById('password-error').classList.remove('hidden');
                }
            } catch (err) {
                alert("Error checking password.");
            }
        }

        function backToBooking() {
            document.getElementById('customer-booking').classList.remove('hidden');
            document.getElementById('business-portal').classList.add('hidden');
            document.getElementById('success-page').classList.add('hidden');
            resetBookingState();
        }

        function goBack() {
            if (state.currentStep > 1) {
                // If leaving the Calendar/Time slot screen (Step 3), reset selection to force re-search
                if (state.currentStep === 3) {
                    state.selectedDate = null;
                    state.selectedTime = null;
                    // Reset to current week so they don't get stuck on a far-future week
                    state.currentWeekStart = getStartOfWeek(new Date());
                }
                
                state.currentStep--;
                updateStepIndicators();
                showCurrentStep();
            } else {
                // Go home if back is pressed on first step
                window.location.href = 'https://dexafitkc.com';
            }
        }
        
        function resetBookingState() {
            state.currentStep = 1;
            state.customerEmail = '';
            state.existingCustomer = null;
            state.selectedServices = [];
            state.selectedDate = null;
            state.selectedTime = null;
            state.totalDuration = 0;
            state.totalPrice = 0;
            state.credits = [];
            state.giftCards = [];
            state.questionAnswers = {};
            document.getElementById('customer-email').value = '';
            document.getElementById('customer-name-display').classList.add('hidden');
        }

        function updateStepIndicators() {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step-${i}-indicator`);
                const circle = indicator.querySelector('.step-circle');
                const text = indicator.querySelector('span');
                
                if (i < state.currentStep) {
                    circle.classList.remove('bg-gray-200', 'text-gray-500', 'bg-blue-500', 'text-white');
                    circle.classList.add('bg-green-500', 'text-white');
                    circle.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
                    if (text) text.classList.remove('text-gray-400');
                } else if (i === state.currentStep) {
                    circle.classList.remove('bg-gray-200', 'text-gray-500', 'bg-green-500');
                    circle.classList.add('bg-blue-500', 'text-white');
                    circle.textContent = i;
                    if (text) text.classList.remove('text-gray-400');
                } else {
                    circle.classList.remove('bg-blue-500', 'text-white', 'bg-green-500');
                    circle.classList.add('bg-gray-200', 'text-gray-500');
                    circle.textContent = i;
                    if (text) text.classList.add('text-gray-400');
                }
            }
        }

        function showCurrentStep() {
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`booking-step-${state.currentStep}`).classList.remove('hidden');
        }

        // ============================================
        // EDIT APPOINTMENT FUNCTIONS
        // ============================================
        let editApptState = {};
        
        function openEditAppointmentModal(email, encodedServices, encodedTitle, isoTime) {
            const services = decodeURIComponent(encodedServices);
            const title = decodeURIComponent(encodedTitle);
            const apptDate = new Date(isoTime);
            
            editApptState = { email, services, title, originalTime: isoTime };
            
            document.getElementById('edit-appt-email').value = email;
            document.getElementById('edit-appt-old-title').value = title;
            document.getElementById('edit-appt-old-time').value = isoTime;
            
            // Set date/time inputs
            const tzOffset = apptDate.getTimezoneOffset() * 60000;
            const localDate = new Date(apptDate.getTime() - tzOffset);
            document.getElementById('edit-appt-date').value = localDate.toISOString().split('T')[0];
            const h = apptDate.getHours().toString().padStart(2, '0');
            const m = apptDate.getMinutes().toString().padStart(2, '0');
            document.getElementById('edit-appt-time').value = `${h}:${m}`;
            
            // Populate service checkboxes
            const currentServices = services.split(',').map(s => s.trim());
            const container = document.getElementById('edit-appt-services');
            
            // Use HARDCODED_SERVICES for the full list
            const allServices = HARDCODED_SERVICES;
            
            container.innerHTML = allServices.map(s => {
                const checked = currentServices.some(cs => cs.toLowerCase() === s.name.toLowerCase()) ? 'checked' : '';
                return `
                    <label class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" class="checkbox-custom" value="${s.name}" data-price="${s.price}" data-addon-price="${s.addonPrice}" ${checked} onchange="recalcEditApptPrice()">
                        <span>${s.name}</span>
                        <span class="ml-auto text-sm text-gray-500">$${s.price}</span>
                    </label>
                `;
            }).join('');
            
            recalcEditApptPrice();
            document.getElementById('edit-appt-modal').classList.remove('hidden');
        }
        
        function closeEditApptModal() {
            document.getElementById('edit-appt-modal').classList.add('hidden');
        }
        
        function recalcEditApptPrice() {
            const checkboxes = document.querySelectorAll('#edit-appt-services input[type="checkbox"]:checked');
            let total = 0;
            const count = checkboxes.length;
            const classANames = ['DEXA Body Composition Scan', 'RMR Resting Metabolic Rate | Fasted Test', 'VO2 Max Treadmill Test'];
            
            let countA = 0;
            checkboxes.forEach(cb => {
                if (classANames.some(n => n.toLowerCase() === cb.value.toLowerCase())) countA++;
            });
            
            checkboxes.forEach(cb => {
                const basePrice = parseFloat(cb.dataset.price) || 0;
                const addonPrice = parseFloat(cb.dataset.addonPrice) || 0;
                const isClassA = classANames.some(n => n.toLowerCase() === cb.value.toLowerCase());
                
                if (countA >= 2) {
                    total += addonPrice;
                } else if (countA === 1 && !isClassA) {
                    total += addonPrice;
                } else {
                    total += basePrice;
                }
            });
            
            document.getElementById('edit-appt-price').textContent = `$${total.toFixed(2)}`;
        }
        
        async function saveAppointmentEdit() {
            const checkboxes = document.querySelectorAll('#edit-appt-services input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('At least one service is required.');
                return;
            }
            
            const newServices = Array.from(checkboxes).map(cb => cb.value);
            const newDate = document.getElementById('edit-appt-date').value;
            const newTime = document.getElementById('edit-appt-time').value;
            const email = document.getElementById('edit-appt-email').value;
            const priceText = document.getElementById('edit-appt-price').textContent;
            const newPrice = parseFloat(priceText.replace('$', '')) || 0;
            
            if (!newDate || !newTime) {
                alert('Please select a date and time.');
                return;
            }
            
            const btn = document.querySelector('#edit-appt-modal .btn-primary');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;display:inline-block;"></div> Saving...';
            
            try {
                const response = await callAppsScript('updateAppointment', {
                    email: email,
                    oldTime: editApptState.originalTime,
                    newDate: newDate,
                    newTime: newTime,
                    newServices: newServices,
                    newPrice: newPrice
                });
                
                if (response.error) {
                    alert(response.error);
                } else {
                    closeEditApptModal();
                    // Reload the appointments for the current date
                    const dateInput = document.getElementById('bookings-date');
                    if (dateInput) loadAppointmentsForDate(dateInput.value);
                }
            } catch (e) {
                alert('Error saving: ' + e.message);
            }
            
            btn.disabled = false;
            btn.innerHTML = 'Save Changes';
        }
        
        async function cancelAppointment() {
            if (!confirm('Are you sure you want to cancel this appointment? This will mark it as cancelled and remove the calendar event.')) return;
            
            const email = document.getElementById('edit-appt-email').value;
            
            try {
                const response = await callAppsScript('cancelAppointment', {
                    email: email,
                    oldTime: editApptState.originalTime
                });
                
                if (response.error) {
                    alert(response.error);
                } else {
                    closeEditApptModal();
                    const dateInput = document.getElementById('bookings-date');
                    if (dateInput) loadAppointmentsForDate(dateInput.value);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // ============================================
        // CUSTOMER BOOKING FLOW
        // ============================================
        async function checkEmail() {
            const email = document.getElementById('customer-email').value.trim();
            const btn = document.querySelector('#booking-step-1 .btn-primary');
            
            // 1. Validate Email
            if (!validateEmail(email)) {
                document.getElementById('email-error').classList.remove('hidden');
                return;
            }
            document.getElementById('email-error').classList.add('hidden');
        
            // 2. Get Turnstile Token
            const turnstileResponse = document.querySelector('[name="cf-turnstile-response"]');
            if (!turnstileResponse || !turnstileResponse.value) {
                alert("Please complete the security check.");
                return;
            }
            const token = turnstileResponse.value;
        
            // 3. Verify Turnstile
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="spinner"></div> Verifying...';
            btn.disabled = true;
        
            try {
                const verification = await callAppsScript('verifyTurnstile', { token });
                if (!verification.success) {
                    alert("Security verification failed. Please try again.");
                    // Reset Turnstile (if using explicit rendering, otherwise page reload might be needed or reset via JS)
                    if (window.turnstile) turnstile.reset(); 
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
            } catch (e) {
                alert("Error verifying security. Try again later.");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }
        
            // 4. Proceed with Email Check (Existing logic)
            state.customerEmail = email;
            btn.innerHTML = '<div class="spinner"></div> Loading...';
            
            try {
                const response = await callAppsScript('checkCustomer', { email });
                if (response.exists) {
                    state.existingCustomer = response.customer;
                    document.getElementById('welcome-name').textContent = response.customer.fullName;
                    document.getElementById('customer-name-display').classList.remove('hidden');
                    state.credits = response.credits || [];
                    state.giftCards = response.giftCards || [];
                }
            } catch (error) {
                console.error("Backend Connection Failed:", error);
            }
        
            btn.innerHTML = originalText;
            btn.disabled = false;
        
            state.currentStep = 2;
            updateStepIndicators();
            showCurrentStep();
            loadServices()
        }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        
        // Helper to toggle description expansion
        function toggleDesc(btn) {
            const parent = btn.parentElement;
            const shortEl = parent.querySelector('.desc-short');
            const fullEl = parent.querySelector('.desc-full');
            
            if (fullEl.classList.contains('hidden')) {
                shortEl.classList.add('hidden');
                fullEl.classList.remove('hidden');
                btn.textContent = 'Show less';
            } else {
                shortEl.classList.remove('hidden');
                fullEl.classList.add('hidden');
                btn.textContent = 'Show more';
            }
        }


        function getCreditBadge(service) {
            const credit = state.credits.find(c => c.name === service.name && c.used < 1);
            if (credit) {
                return `<div class="mt-3 pt-3 border-t border-green-200 bg-green-50 -mx-6 -mb-6 px-6 py-3 rounded-b-2xl">
                    <p class="text-sm text-green-600 font-semibold">You have ${credit.value} credit(s) for this service</p>
                </div>`;
            }
            return '';
        }

        function toggleService(serviceId) {
            const index = state.selectedServices.indexOf(serviceId);
            const card = document.querySelector(`[data-service-id="${serviceId}"]`);
            
            if (index > -1) {
                state.selectedServices.splice(index, 1);
                card.classList.remove('selected');
                card.querySelector('.service-checkbox').classList.remove('bg-blue-500', 'border-blue-500');
                card.querySelector('.service-checkbox').classList.add('border-gray-300');
                card.querySelector('.check-icon').classList.add('hidden');
            } else {
                state.selectedServices.push(serviceId);
                card.classList.add('selected');
                card.querySelector('.service-checkbox').classList.add('bg-blue-500', 'border-blue-500');
                card.querySelector('.service-checkbox').classList.remove('border-gray-300');
                card.querySelector('.check-icon').classList.remove('hidden');
            }
        
            updateOrderSummary();
            updateServiceCardsUI();
        }

        function reloadServicesForAddons() {
            // Update addon price highlights
            document.querySelectorAll('.addon-price-section').forEach(el => {
                if (state.selectedServices.length > 0) {
                    el.classList.add('highlight', 'bg-blue-50', 'rounded-lg', 'p-2', '-mx-2');
                }
            });
        }

        async function loadServices() {
            const container = document.getElementById('services-grid');
            container.innerHTML = `<div class="spinner"></div>`;
        
            let servicesData = HARDCODED_SERVICES.map(s => ({
                ...s,
                price: parseFloat(s.price),
                duration: parseInt(s.duration),
                addonPrice: parseFloat(s.addonPrice),
                addonDuration: parseInt(s.addonDuration)
            }));
        
            if (!state.existingCustomer) {
                const stykuIndex = servicesData.findIndex(s => s.id === '4');
                if (stykuIndex !== -1) {
                    servicesData[stykuIndex] = {
                        ...servicesData[stykuIndex],
                        name: 'New Customer Free Styku Offer',
                        price: 0,
                        addonPrice: 0,
                    };
                }
            }
        
            state.services = servicesData;
        
            container.innerHTML = state.services.map(service => {
                const shortDesc = service.description || '';
                const isLong = shortDesc.length > 80;
                const displayDesc = isLong ? shortDesc.substring(0, 80) + '...' : shortDesc;
                const hasDiffPrice = service.addonPrice !== service.price;
                const hasDiffDuration = service.addonDuration !== service.duration;
        
                return `
                <div class="service-card glass-card rounded-2xl p-6 border-2 border-transparent cursor-pointer" 
                     data-service-id="${service.id}" onclick="toggleService('${service.id}')">
                    <div class="flex items-start justify-between mb-4">
                        <h3 class="font-bold text-lg">${service.name}</h3>
                        <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center service-checkbox transition-all">
                            <svg class="w-4 h-4 text-white hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                    </div>
                    <div class="text-gray-600 text-sm mb-4">
                        <span class="desc-short">${displayDesc}</span>
                        ${isLong ? `<span class="desc-full hidden">${shortDesc}</span><button class="text-blue-500 text-xs ml-1 hover:underline" onclick="event.stopPropagation(); toggleDesc(this)">Show more</button>` : ''}
                    </div>
                    <div class="flex items-center justify-between text-sm mb-2">
                        <span class="text-gray-500">Duration</span>
                        <div class="font-semibold text-right">
                            <span class="base-duration">${service.duration} min</span>
                            ${hasDiffDuration ? `
                                <span class="addon-duration hidden">
                                    <s class="text-gray-400 mr-1">${service.duration} min</s>
                                    <span class="text-blue-600">${service.addonDuration} min</span>
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-500">Price</span>
                        <div class="font-semibold text-right">
                            <span class="base-price">$${service.price.toFixed(2)}</span>
                            ${hasDiffPrice ? `
                                <span class="addon-price hidden">
                                    <s class="text-gray-400 mr-1">$${service.price.toFixed(2)}</s>
                                    <span class="text-blue-600">$${service.addonPrice.toFixed(2)}</span>
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    ${getCreditBadge(service)}
                </div>`;
            }).join('');
        
            updateServiceCardsUI();
            updateOrderSummary();
        }

        // Consultation Service ID
        const CONSULTATION_ID = '6';
        
        function updateServiceCardsUI() {
            // Calculate counts for logic
            const countA = state.selectedServices.filter(id => CLASS_A_IDS.includes(id)).length;
            
            document.querySelectorAll('.service-card').forEach(card => {
                const cardId = card.dataset.serviceId;
                const service = state.services.find(s => s.id === cardId);
                if (!service) return;
        
                // Determine if THIS specific card should show Addon or Base visuals
                let showBundleView = false;
                
                // Logic based on Class A count
                if (countA === 0) {
                    // Rule 1 & 2: No Class A selected -> Everything is Base
                    showBundleView = false;
                } else if (countA === 1) {
                    // Rule 3: One Class A selected
                    const isThisSelectedClassA = CLASS_A_IDS.includes(cardId) && state.selectedServices.includes(cardId);
                    
                    if (isThisSelectedClassA) {
                        // The selected Class A stays at Base
                        showBundleView = false;
                    } else {
                        // Everything else (Class B, unselected Class As) is Addon
                        showBundleView = true;
                    }
                } else {
                    // Rule 4 & 5: Multiple Class As selected -> Everything is Addon
                    showBundleView = true;
                }
        
                // --- Duration Logic ---
                const baseDur = card.querySelector('.base-duration');
                const addonDur = card.querySelector('.addon-duration');
                const isDiffDuration = service.addonDuration !== service.duration;
        
                if (showBundleView && isDiffDuration && addonDur) {
                    if (baseDur) baseDur.classList.add('hidden');
                    addonDur.classList.remove('hidden');
                } else {
                    if (baseDur) baseDur.classList.remove('hidden');
                    if (addonDur) addonDur.classList.add('hidden');
                }
        
                // --- Price Logic ---
                const basePrice = card.querySelector('.base-price');
                const addonPriceEl = card.querySelector('.addon-price');
                const isDiffPrice = service.addonPrice !== service.price;
        
                if (showBundleView && isDiffPrice && addonPriceEl) {
                    if (basePrice) basePrice.classList.add('hidden');
                    addonPriceEl.classList.remove('hidden');
                } else {
                    if (basePrice) basePrice.classList.remove('hidden');
                    if (addonPriceEl) addonPriceEl.classList.add('hidden');
                }
            });
        }

        async function addCreditingCustomer() {
            const email = document.getElementById('crediting-customer-email').value.trim();
            if (!email) { alert("Please enter an email."); return; }
            
            // Check if already in the checkout emails
            const existingEmails = [...new Set(state.checkoutSelected.map(id => {
                const a = state.checkoutAppointments.find(appt => appt.id === id);
                return a ? a.email : null;
            }).filter(e => e))];
            
            if (!state.creditingCustomers) state.creditingCustomers = [];
            
            // Don't add duplicates
            if (existingEmails.includes(email.toLowerCase()) || state.creditingCustomers.includes(email.toLowerCase())) {
                alert("This customer's credits are already loaded.");
                return;
            }
            
            // Fetch their credits
            try {
                const response = await callAppsScript('getCheckoutData', { emails: [email] });
                const newCredits = response.credits || [];
                const newGCs = response.giftCards || [];
                
                if (newCredits.length === 0 && newGCs.length === 0) {
                    alert("No available credits or gift cards found for this email.");
                    return;
                }
                
                // Add to state
                state.creditingCustomers.push(email.toLowerCase());
                state.checkoutAvailableCredits = [...state.checkoutAvailableCredits, ...newCredits];
                state.checkoutAvailableGCs = [...state.checkoutAvailableGCs, ...newGCs];
                
                // Show in UI
                const container = document.getElementById('crediting-customer-list');
                container.innerHTML += `
                    <div class="flex items-center justify-between bg-white p-2 rounded border border-purple-200 text-sm">
                        <span class="font-medium">${email}</span>
                        <span class="text-purple-600">${newCredits.length} credit(s), ${newGCs.length} GC(s)</span>
                    </div>
                `;
                
                // Re-render the credit dropdowns and GC inputs
                updateCreditDropdowns();
                renderGiftCardInputs();
                recalcCheckoutTotal();
                
                document.getElementById('crediting-customer-email').value = '';
                
            } catch (e) {
                alert("Error fetching credits: " + e.message);
            }
        }
        
        function updateOrderSummary() {
            let totalDuration = 0;
            let totalPrice = 0;
            let creditsUsedCount = 0;
        
            if (!state.services || state.services.length === 0) return;
        
            // 1. Identify Selected Services
            let selectedItems = state.selectedServices.map(id => {
                const s = state.services.find(srv => srv.id === id);
                return s ? { ...s } : null;
            }).filter(item => item !== null);
        
            // 2. Count Class A vs Class B
            const classA = selectedItems.filter(s => CLASS_A_IDS.includes(s.id));
            const classB = selectedItems.filter(s => !CLASS_A_IDS.includes(s.id));
            
            const countA = classA.length;
            const countB = classB.length;
        
            // 3. Apply Pricing Logic
            selectedItems.forEach((service) => {
                // Check for Credit
                const hasCredit = state.credits.find(c => 
                    c.name.toLowerCase() === service.name.toLowerCase() && c.used < 1
                );
        
                if (hasCredit) {
                    creditsUsedCount++;
                    totalDuration += (service.addonDuration || service.duration);
                } else {
                    let price = service.price;
                    let duration = service.duration;
                    
                    const isClassA = CLASS_A_IDS.includes(service.id);
        
                    if (countA >= 2) {
                        // Rule 4 & 5: Multiple As -> All Addon
                        price = (service.addonPrice !== undefined && service.addonPrice !== null) ? service.addonPrice : service.price;
                        duration = service.addonDuration || service.duration;
                    } else if (countA === 1) {
                        // Rule 2: One A + B
                        if (isClassA) {
                            // The Class A is Base
                            price = service.price;
                            duration = service.duration;
                        } else {
                            // The Class B is Addon
                            price = (service.addonPrice !== undefined && service.addonPrice !== null) ? service.addonPrice : service.price;
                            duration = service.addonDuration || service.duration;
                        }
                    } else {
                        // countA == 0
                        // Rule 3: Multiple B = Base
                        price = service.price;
                        duration = service.duration;
                    }
        
                    totalPrice += price;
                    totalDuration += duration;
                }
            });
        
            // 4. Gift Card Logic (Existing)
            const activeGC = state.giftCards.find(gc => gc.used < 1 && gc.name.toLowerCase() === 'gc');
            let gcTotal = activeGC ? activeGC.value : 0;
            let gcApplied = 0;
        
            if (activeGC) {
                gcApplied = Math.min(totalPrice, activeGC.value);
                totalPrice -= gcApplied;
            }
        
            state.totalDuration = totalDuration;
            state.totalPrice = Math.max(0, totalPrice);
        
            // 5. Update UI
            document.getElementById('total-duration').textContent = `${totalDuration} min`;
            document.getElementById('total-price').textContent = `$${state.totalPrice.toFixed(2)}`;
        
            const creditNote = document.getElementById('credit-usage-note');
            if (activeGC || creditsUsedCount > 0) {
                creditNote.classList.remove('hidden');
                let notes = [];
                if (creditsUsedCount > 0) notes.push(`${creditsUsedCount} service credit(s)`);
                if (activeGC) notes.push(`$${gcApplied.toFixed(2)} from Gift Card applied`);
                creditNote.innerHTML = `Applied: ${notes.join(' & ')}<br>
                    <span class="text-xs font-normal text-gray-500">Total Gift Card Balance: $${gcTotal.toFixed(2)}</span>`;
            } else {
                creditNote.classList.add('hidden');
            }
        
            const continueBtn = document.getElementById('continue-schedule-btn');
            continueBtn.disabled = state.selectedServices.length === 0;
            if (state.selectedServices.length > 0) continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            else continueBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            updateServiceCardsUI();
        }

        function continueToSchedule() {
            state.currentStep = 3;
            updateStepIndicators();
            showCurrentStep();
            loadCalendar();
        }

        function loadCalendar() {
            state.currentWeekStart = getStartOfWeek(new Date());
            
            // Explicitly hide the time slots container when loading the calendar
            const tsContainer = document.getElementById('time-slots-container');
            if (tsContainer) tsContainer.classList.add('hidden');
            
            renderCalendar();
        }

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function changeWeek(direction) {
            state.currentWeekStart.setDate(state.currentWeekStart.getDate() + (direction * 7));
            renderCalendar();
        }

        function renderCalendar() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month').textContent = `${monthNames[state.currentWeekStart.getMonth()]} ${state.currentWeekStart.getFullYear()}`;
        
            const dateSelector = document.getElementById('date-selector');
            dateSelector.innerHTML = ''; // Clear
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
        
            // Render 14 days (2 weeks) instead of 7
            for (let i = 0; i < 14; i++) {
                const date = new Date(state.currentWeekStart);
                date.setDate(date.getDate() + i);
                const isPast = date < today;
                const isSelected = state.selectedDate && date.toDateString() === state.selectedDate.toDateString();
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
                // Simple grid layout handling for 14 items
                // Apply a grid class to the container in HTML: "grid-cols-7"
                
                dateSelector.innerHTML += `
                    <button class="aspect-square p-1 sm:p-4 rounded-xl text-center transition-all flex flex-col items-center justify-center ${isPast ? 'opacity-40 cursor-not-allowed' : 'hover:bg-blue-50'} ${isSelected ? 'bg-blue-500 text-white shadow-md' : ''}"
                            onclick="${!isPast ? `selectDate(${date.getTime()})` : ''}"
                            ${isPast ? 'disabled' : ''}>
                        <div class="text-xs ${isSelected ? 'text-blue-100' : 'text-gray-500'}">${dayNames[date.getDay()]}</div>
                        <div class="text-base sm:text-lg font-bold">${date.getDate()}</div>
                    </button>
                `;
            }
        }

        function selectDate(timestamp) {
            state.selectedDate = new Date(timestamp);
            renderCalendar();
            loadTimeSlots();
        }

        async function loadTimeSlots() {
            document.getElementById('time-slots-container').classList.remove('hidden');
            const container = document.getElementById('time-slots');
            
            // Show loading
            container.innerHTML = '<div class="col-span-5 text-center py-8"><div class="loading-skeleton h-12 rounded-lg mb-2"></div><p class="text-gray-500">Loading available times...</p></div>';

            try {
                const response = await callAppsScript('getAvailability', {
                    date: state.selectedDate.toISOString(),
                    duration: state.totalDuration
                });
                renderTimeSlots(response.slots);
            }catch (error) {
                // Render empty or error
                renderTimeSlots([]); // CHANGED
            }
        }

        function renderTimeSlots(slots) {
            const container = document.getElementById('time-slots');
            
            // If backend filters correctly, slots array only contains available times.
            // We just render them.
            if (slots.length === 0) {
                container.innerHTML = '<p class="col-span-5 text-center text-gray-500 py-8">No available times for this date.</p>';
                return;
            }
        
            container.innerHTML = slots.map(slot => `
                <button class="time-slot p-3 rounded-xl border-2 border-gray-200 font-medium hover:bg-blue-500 hover:text-white transition-all ${state.selectedTime === slot.time ? 'selected bg-blue-500 text-white' : ''}"
                        onclick="selectTime('${slot.time}')">
                    ${formatTime(slot.time)}
                </button>
            `).join('');
        }

        function formatTime(time) {
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
        }

        function selectTime(time) {
            state.selectedTime = time;
            document.querySelectorAll('.time-slot').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent.trim() === formatTime(time)) {
                    btn.classList.add('selected');
                }
            });
            document.getElementById('continue-details-btn').disabled = false;
        }

        function continueToDetails() {
            state.currentStep = 4;
            updateStepIndicators();
            showCurrentStep();
            loadQuestions();
        }

        function toggleHWFields(show) {
            const fields = document.getElementById('hw-fields');
            if (show) {
                fields.classList.remove('hidden');
                // Clear values when 'Yes' is clicked so they must enter new info
                document.getElementById('input-height').value = '';
                document.getElementById('input-weight').value = '';
            } else {
                fields.classList.add('hidden');
            }
        }

        async function loadQuestions() {
            const container = document.getElementById('questions-container');
            const newCustFields = document.getElementById('new-customer-fields');
            const hwSection = document.getElementById('hw-section');
            const submitBtn = document.querySelector('#booking-details-form button[type="submit"]');
        
            container.innerHTML = `<div class="text-center py-10"><div class="spinner"></div></div>`;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner"></div> Loading...';
        
            // 1. Get Hardcoded Questions
            const allQuestions = HARDCODED_QUESTIONS;
        
            // 2. Calculate Exclusions (JS Logic)
            const selectedIds = state.selectedServices; // Array of IDs like ['1', '2']
            const totalSelected = selectedIds.length;
            const exclusionCounts = {};
        
            if (totalSelected > 0) {
                selectedIds.forEach(sId => {
                    const service = state.services.find(s => s.id == sId);
                    if (service && service.excludedQuestions) {
                        const excludedList = service.excludedQuestions.split(',').map(id => id.trim()).filter(id => id);
                        excludedList.forEach(qId => {
                            exclusionCounts[qId] = (exclusionCounts[qId] || 0) + 1;
                        });
                    }
                });
            }
        
            // 3. Filter Questions
            // Note: We are not implementing 'ask once' logic here as we don't have the history from backend.
            // If needed, we'd need a backend call just for history. Assuming 'every time' for now based on data.
            state.questions = allQuestions.filter(q => {
                // Hide if ALL services exclude it
                if (totalSelected > 0 && exclusionCounts[q.id] === totalSelected) {
                    return false;
                }
                return true;
            });
        
            // 4. Handle UI State & Validation
            // CORRECTED IDs: The HTML uses 'input-sex' for the booking form, not 'edit-sex'
            const fieldsToToggle = [
                'input-fullName', 'input-phone', 'input-sex', 
                'input-dob', 'input-height-new', 'input-weight-new', 'input-ethnicity'
            ];
            
            if (!state.existingCustomer) {
                // === NEW CUSTOMER ===
                newCustFields.classList.remove('hidden');
                hwSection.classList.add('hidden');
                
                fieldsToToggle.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.disabled = false;
                        // Only set required on key fields defined in HTML or logic
                        if (['input-fullName', 'input-phone', 'input-sex'].includes(id)) { // Added sex as usually required
                            el.setAttribute('required', '');
                        }
                    }
                });
                
            } else {
                // === EXISTING CUSTOMER ===
                newCustFields.classList.add('hidden');
                hwSection.classList.remove('hidden');
                
                fieldsToToggle.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.disabled = true; // Disable to skip validation
                        el.removeAttribute('required');
                    }
                });
            }
        
            container.innerHTML = state.questions.map(q => renderQuestion(q)).join('');
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Complete Booking';
        }

        function renderQuestion(question) {
            const inputId = `question-${question.id}`;
            const requiredAttr = question.required ? 'required' : ''; 
            const requiredStar = question.required ? '<span class="text-red-500">*</span>' : '';
            
            let inputHtml = '';
            let topLabelHtml = ''; // Separate label for top
        
            switch (question.type) {
                case 'short text':
                    inputHtml = `<input type="text" id="${inputId}" name="${question.id}" class="input-field w-full px-4 py-3 rounded-xl" ${requiredAttr}>`;
                    topLabelHtml = `<label class="block text-sm font-semibold text-gray-700 mb-2">${question.text} ${requiredStar}</label>`;
                    break;
                case 'long text':
                    inputHtml = `<textarea id="${inputId}" name="${question.id}" class="input-field w-full px-4 py-3 rounded-xl" rows="4" ${requiredAttr}></textarea>`;
                    topLabelHtml = `<label class="block text-sm font-semibold text-gray-700 mb-2">${question.text} ${requiredStar}</label>`;
                    break;
                case 'checkbox':
                    // Process text for URLs
                    let processedText = question.text;
                    processedText = processedText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-600 underline hover:text-blue-800">$1</a>');
                    processedText = processedText.replace(/(?<!href=")https?:\/\/[^\s<]+/g, '<a href="$&" target="_blank" class="text-blue-600 underline hover:text-blue-800">$&</a>');
        
                    // For checkboxes, we use the clickable label as the main label.
                    // We do NOT use topLabelHtml here to avoid duplication.
                    inputHtml = `
                        <label class="flex items-start gap-3 cursor-pointer p-1">
                            <input type="checkbox" id="${inputId}" name="${question.id}" class="checkbox-custom mt-1" ${requiredAttr}>
                            <span class="text-gray-700">${processedText} ${requiredStar}</span>
                        </label>
                    `;
                    break;
                case 'number':
                    inputHtml = `<input type="number" id="${inputId}" name="${question.id}" class="input-field w-full px-4 py-3 rounded-xl" ${requiredAttr}>`;
                    topLabelHtml = `<label class="block text-sm font-semibold text-gray-700 mb-2">${question.text} ${requiredStar}</label>`;
                    break;
                case 'date':
                    inputHtml = `<input type="date" id="${inputId}" name="${question.id}" class="input-field w-full px-4 py-3 rounded-xl" ${requiredAttr}>`;
                    topLabelHtml = `<label class="block text-sm font-semibold text-gray-700 mb-2">${question.text} ${requiredStar}</label>`;
                    break;
            }
        
            return `
                <div class="question-item bg-gray-50 p-4 rounded-xl">
                    ${topLabelHtml}
                    ${inputHtml}
                </div>
            `;
        }

        function submitBooking(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            
            // STOP DOUBLE CLICKS
            if (btn.disabled) return; 
            
            // ============================================
            // MANUAL VALIDATION FOR REQUIRED CHECKBOXES
            // ============================================
            // Select all required checkboxes that are NOT checked
            const requiredCheckboxes = document.querySelectorAll('#questions-container input[type="checkbox"][required]');
            let allChecked = true;
            
            requiredCheckboxes.forEach(cb => {
                if (!cb.checked) {
                    allChecked = false;
                    // Optional: Highlight the parent label to show error
                    cb.closest('.question-item').style.border = "2px solid red";
                } else {
                    cb.closest('.question-item').style.border = "none";
                }
            });
        
            if (!allChecked) {
                alert("Please check all required boxes before booking.");
                return; // Stop submission
            }
            
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:3px;"></div> Booking...';
            
            const formData = new FormData(e.target);
            const customerData = {};
            const questionResponses = {};
        
            // Logic for Existing vs New
            if (state.existingCustomer) {
                const hwChanged = formData.get('hw-changed') === 'yes';
                if (hwChanged) {
                    customerData.height = formData.get('height');
                    customerData.weight = formData.get('weight');
                }
                customerData.fullName = state.existingCustomer.fullName;
                customerData.id = state.existingCustomer.id;
            } else {
                customerData.fullName = formData.get('fullName');
                customerData.phone = formData.get('phone');
                customerData.dob = formData.get('dob');
                customerData.sex = formData.get('sex');
                customerData.height = formData.get('heightNew');
                customerData.weight = formData.get('weightNew');
                customerData.ethnicity = formData.get('ethnicity');
            }
        
            // Get question responses
            for (const [key, value] of formData.entries()) {
                // Exclude non-question fields
                if (['hw-changed', 'fullName', 'phone', 'dob', 'sex', 'heightNew', 'weightNew', 'ethnicity', 'height', 'weight'].includes(key)) continue;
                if (value) questionResponses[key] = value;
            }
        
            const bookingData = {
                customerEmail: state.customerEmail,
                customerData,
                isNewCustomer: !state.existingCustomer,
                services: state.selectedServices.map(id => state.services.find(s => s.id === id)),
                date: state.selectedDate.toISOString(),
                time: state.selectedTime,
                duration: state.totalDuration,
                price: state.totalPrice,
                questionResponses
            };
        
            callAppsScript('createBooking', bookingData)
                .then(response => {
                    if (response.success) {
                        window.location.href = 'https://dexafitkc.com/success';
                    } else {
                        throw new Error(response.error || "Booking failed");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("There was an error processing your booking.");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }

        function handleQuestionChange(questionId, hasChanged) {
            if (hasChanged) {
                // Show the question
                document.querySelector(`[data-question-id="${questionId}"]`).style.display = 'block';
            } else {
                // Hide and use previous answer
                document.querySelector(`[data-question-id="${questionId}"]`).style.display = 'none';
            }
            closeQuestionChangeModal();
        }

        function closeQuestionChangeModal() {
            document.getElementById('question-change-modal').classList.add('hidden');
        }

        function showSuccessPage(bookingData) {
            document.getElementById('customer-booking').classList.add('hidden');
            document.getElementById('success-page').classList.remove('hidden');

            const detailsHtml = `
                <p><strong>Date:</strong> ${state.selectedDate.toLocaleDateString()}</p>
                <p><strong>Time:</strong> ${formatTime(state.selectedTime)}</p>
                <p><strong>Duration:</strong> ${state.totalDuration} minutes</p>
                <p><strong>Services:</strong> ${state.selectedServices.map(id => state.services.find(s => s.id === id).name).join(', ')}</p>
                <p><strong>Total:</strong> $${state.totalPrice.toFixed(2)}</p>
            `;
            document.getElementById('success-details').innerHTML = detailsHtml;
        }

        // ============================================
        // BUSINESS PORTAL
        // ============================================
        function showBusinessSection(section) {
            console.log(`Switching to section: ${section}`);
            
            try {
                // 1. Hide all sections
                document.querySelectorAll('.business-section').forEach(el => {
                    el.classList.add('hidden');
                });
        
                // 2. Show target section
                const targetEl = document.getElementById(`section-${section}`);
                if (!targetEl) {
                    console.error(`CRITICAL: HTML element 'section-${section}' not found in the file!`);
                    return;
                }
                targetEl.classList.remove('hidden');
                console.log(`Section ${section} shown.`);
        
                // 3. Update Sidebar
                document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
                const activeBtn = document.querySelector(`[data-section="${section}"]`);
                if (activeBtn) activeBtn.classList.add('active');
        
                // 4. Load Data Safely
                switch(section) {
                    case 'customers': 
                        if (typeof loadBusinessCustomers === 'function') loadBusinessCustomers(); 
                        break;
                    case 'bookings': 
                        if (typeof loadTodaysBookings === 'function') loadTodaysBookings(); 
                        break;
                    case 'credits': 
                        if (typeof loadCreditManagement === 'function') loadCreditManagement(); 
                        break;
                    case 'checkout': 
                        if (typeof loadCheckoutSection === 'function') loadCheckoutSection(); 
                        break;
                }
                
            } catch (e) {
                console.error(`Error loading section ${section}:`, e);
            }
        }

        async function loadBusinessData() {
            showBusinessSection('dashboard');
        }

        async function loadDashboard() {
            try {
                // Safe updates: Check if element exists before updating
                const updateText = (id, text) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = text;
                };
        
                updateText('stat-today-appts', '0');
                updateText('stat-today-revenue', '$0');
                updateText('stat-total-customers', '0');
                updateText('stat-active-services', '0');
        
                const upcomingEl = document.getElementById('upcoming-appts');
                if (upcomingEl) upcomingEl.innerHTML = '<p class="text-gray-500 text-sm">No upcoming appointments.</p>';
        
                const recentEl = document.getElementById('recent-customers');
                if (recentEl) recentEl.innerHTML = '<p class="text-gray-500 text-sm">No recent customers.</p>';
                
            } catch (e) {
                console.error("Dashboard load error", e);
            }
        }

        async function loadBusinessCustomers() {
            const tbody = document.getElementById('customers-table-body');
            const container = document.getElementById('customers-list');
            
            state.customerPage = 0;
            state.customerSearch = ''; // Reset search
            
            // Robustly ensure "Load More" button exists
            let loadMoreDiv = document.getElementById('load-more-customers-btn');
            if (!loadMoreDiv && container) {
                loadMoreDiv = document.createElement('div');
                loadMoreDiv.id = 'load-more-customers-btn';
                loadMoreDiv.className = 'p-4 text-center hidden';
                loadMoreDiv.innerHTML = '<button onclick="loadMoreCustomers()" class="btn-secondary">Load More</button>';
                container.appendChild(loadMoreDiv);
            }
            
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-500">Loading...</td></tr>';
            
            try {
                const response = await callAppsScript('getCustomers', { page: state.customerPage, search: '' });
                state.customers = response.customers || [];
                
                renderCustomerRows(state.customers);
                if (loadMoreDiv) loadMoreDiv.classList.toggle('hidden', !response.hasMore);
                
            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-red-500">Error loading customers.</td></tr>';
            }
        }
        
        // Timer variables for debounce
        let searchTimeoutCustomer;
        let searchTimeoutCredit;

        // Debounce Customer Search
        function debounceSearchCustomers(query) {
            clearTimeout(searchTimeoutCustomer);
            
            // If empty, reset to default list
            if (query.length === 0) {
                loadBusinessCustomers();
                return;
            }
            
            // Only search if more than 3 characters
            if (query.length > 3) {
                searchTimeoutCustomer = setTimeout(() => {
                    searchCustomers(query);
                }, 400); // Wait 400ms after last keystroke
            }
        }

        // Debounce Credit Search
        function debounceSearchCredits(query) {
            clearTimeout(searchTimeoutCredit);
            
            // If empty, reset to default list
            if (query.length === 0) {
                loadCreditManagement();
                return;
            }
            
            // Only search if more than 3 characters
            if (query.length > 3) {
                searchTimeoutCredit = setTimeout(() => {
                    searchCredits(query);
                }, 400); // Wait 400ms after last keystroke
            }
        }
        
        async function searchCustomers(query) {
            state.customerSearch = query;
            state.customerPage = 0;
            
            const tbody = document.getElementById('customers-table-body');
            const loadMoreDiv = document.getElementById('load-more-customers-btn');
            
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-500">Searching...</td></tr>';
            
            try {
                const response = await callAppsScript('getCustomers', { page: 0, search: query });
                state.customers = response.customers || [];
                
                renderCustomerRows(state.customers);
                if (loadMoreDiv) loadMoreDiv.classList.toggle('hidden', !response.hasMore);
                
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-red-500">Error searching.</td></tr>';
            }
        }
        
        async function loadMoreCustomers() {
            state.customerPage++;
            const btn = document.querySelector('#load-more-customers-btn button');
            if(!btn) return;
            
            btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div>';
            
            try {
                const response = await callAppsScript('getCustomers', { page: state.customerPage, search: state.customerSearch });
                const newCustomers = response.customers || [];
                
                state.customers = [...state.customers, ...newCustomers];
                renderCustomerRows(newCustomers);
                
                btn.innerHTML = 'Load More';
                const container = document.getElementById('load-more-customers-btn');
                if (container) container.classList.toggle('hidden', !response.hasMore);
            } catch (e) {
                console.error(e);
                btn.innerHTML = 'Load More';
            }
        }
        
        function renderCustomerRows(customers) {
            const tbody = document.getElementById('customers-table-body');
            if (customers.length === 0 && state.customerPage === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No customers found.</td></tr>';
                return;
            }
            
            let html = customers.map(customer => {
                // Format notes: Show truncated version with full text on hover
                const notes = customer.notes || '-';
                const shortNotes = notes.length > 30 ? notes.substring(0, 30) + '...' : notes;
                
                return `
                <tr class="table-row border-b border-gray-50">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center font-bold text-blue-600 text-sm">
                                ${customer.fullName.split(' ').map(n => n[0]).join('')}
                            </div>
                            <span class="font-medium">${customer.fullName}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-gray-600">${customer.email}</td>
                    <td class="px-6 py-4 text-gray-600">${customer.phone || '-'}</td>
                    <td class="px-6 py-4 text-gray-600 text-sm" title="${customer.notes || ''}">${shortNotes}</td>
                    <td class="px-6 py-4">
                        <button onclick="editCustomer('${customer.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">Edit</button>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="startBookingForEmail('${customer.email}')" class="text-green-600 hover:text-green-800 text-sm font-semibold">Book</button>
                    </td>
                </tr>
            `}).join('');
            
            if(state.customerPage === 0) tbody.innerHTML = html;
            else tbody.insertAdjacentHTML('beforeend', html);
        }

        function openCustomerModal(customerId = null) {
            document.getElementById('customer-modal').classList.remove('hidden');
            document.getElementById('customer-form').reset(); // Clear form first
            
            if (customerId) {
                // Find customer safely (use == to handle string/int ID mismatch)
                const customer = state.customers.find(c => c.id == customerId);
                
                if (customer) {
                    document.getElementById('customer-modal-title').textContent = 'Edit Customer';
                    document.getElementById('edit-customer-id').value = customer.id;
                    
                    // Safely populate fields using fallbacks (|| '') to prevent errors on missing data
                    document.getElementById('edit-fullName').value = customer.fullName || '';
                    document.getElementById('edit-email').value = customer.email || '';
                    document.getElementById('edit-phone').value = customer.phone || '';
                    
                    // Handle DOB formatting safely
                    const dobInput = document.getElementById('edit-dob');
                    if (customer.dob) {
                        try {
                            const d = new Date(customer.dob);
                            // Check if valid date
                            if (!isNaN(d.getTime())) {
                               // Adjust for timezone offset to get correct YYYY-MM-DD
                               let tzOffset = d.getTimezoneOffset() * 60000;
                               let localDate = new Date(d.getTime() - tzOffset);
                               dobInput.value = localDate.toISOString().split('T')[0];
                            } else {
                               dobInput.value = ''; 
                            }
                        } catch (e) {
                            dobInput.value = '';
                        }
                    } else {
                        dobInput.value = '';
                    }

                    // Fix: Case-insensitive Sex selection
                    const sexInput = document.getElementById('edit-sex');
                    const sexVal = customer.sex ? String(customer.sex).toLowerCase() : '';
                    if (sexVal === 'male' || sexVal === 'female') {
                        sexInput.value = sexVal;
                    } else {
                        sexInput.value = ''; // Default to prompt if unknown
                    }
                    
                    document.getElementById('edit-height').value = customer.height || '';
                    document.getElementById('edit-weight').value = customer.weight || '';
                    document.getElementById('edit-ethnicity').value = customer.ethnicity || '';
                    document.getElementById('edit-notes').value = customer.notes || '';
                    
                    // Show history section
                    document.getElementById('customer-history').classList.remove('hidden');
                    document.getElementById('customer-appointments').innerHTML = `<div class="text-sm text-gray-500">Loading history...</div>`;
                    // Fetch and render appointment history
                    loadCustomerHistory(customer.id);
                } else {
                    console.error("Customer not found in state with ID: " + customerId);
                    alert("Error: Could not find customer data.");
                    closeCustomerModal();
                }
            } else {
                // New Customer Mode
                document.getElementById('customer-modal-title').textContent = 'Add Customer';
                document.getElementById('edit-customer-id').value = '';
                document.getElementById('customer-history').classList.add('hidden');
            }
        }

        function editCustomer(customerId) {
            openCustomerModal(customerId);
        }

        async function loadCustomerHistory(customerId) {
            const container = document.getElementById('customer-appointments');
            
            try {
                const response = await callAppsScript('getCustomerHistory', { customerId: customerId });
                const history = response.history || [];
                
                if (history.length === 0) {
                    container.innerHTML = '<div class="text-sm text-gray-500">No appointment history found.</div>';
                    return;
                }
                
                container.innerHTML = history.map(h => {
                    let statusColor = 'bg-gray-100 text-gray-600';
                    if (h.status === 'Completed') statusColor = 'bg-green-100 text-green-700';
                    else if (h.status === 'Scheduled' || h.status === 'Confirmed') statusColor = 'bg-blue-100 text-blue-700';
                    else if (h.status === 'CustCancel') statusColor = 'bg-red-100 text-red-700';
                    
                    let timeDisplay = h.time || '';
                    if (timeDisplay instanceof Date) {
                        timeDisplay = timeDisplay.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    }
                    
                    return `
                        <div class="flex items-center justify-between p-2 bg-white rounded-lg border border-gray-100 text-sm">
                            <div class="flex-1">
                                <span class="font-semibold text-gray-800">${h.date}</span>
                                <span class="text-gray-400 mx-1"></span>
                                <span class="text-gray-500">${timeDisplay}</span>
                            </div>
                            <div class="flex-1 text-center text-gray-700">${h.services}</div>
                            <div class="flex items-center gap-2">
                                <span class="font-semibold">$${parseFloat(h.price || 0).toFixed(2)}</span>
                                <span class="text-xs px-2 py-0.5 rounded-full ${statusColor}">${h.status}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (e) {
                console.error('Error loading history:', e);
                container.innerHTML = '<div class="text-sm text-red-500">Error loading history.</div>';
            }
        }

        // Start booking flow for a specific email (used from customer list Book button and Save & Book)
        async function startBookingForEmail(email) {
            // Switch to customer booking view
            document.getElementById('business-portal').classList.add('hidden');
            document.getElementById('customer-booking').classList.remove('hidden');
            
            // Reset booking state
            resetBookingState();
            
            // Set the email and proceed as if they clicked "Book Now"
            state.customerEmail = email;
            
            // Show loading
            const btn = document.querySelector('#booking-step-1 .btn-primary');
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.innerHTML = '<div class="spinner"></div> Loading...';
                btn.disabled = true;
            }
            
            try {
                const response = await callAppsScript('checkCustomer', { email });
                if (response.exists) {
                    state.existingCustomer = response.customer;
                    document.getElementById('welcome-name').textContent = response.customer.fullName;
                    document.getElementById('customer-name-display').classList.remove('hidden');
                    state.credits = response.credits || [];
                    state.giftCards = response.giftCards || [];
                }
            } catch (error) {
                console.error("Backend Connection Failed:", error);
            }
            
            if (btn) {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
            
            // Go to step 2 (service selection)
            state.currentStep = 2;
            updateStepIndicators();
            showCurrentStep();
            loadServices();
        }
        
        // Save customer data from modal, then start booking with their email
        async function saveAndBook() {
            const customerData = {
                id: document.getElementById('edit-customer-id').value || '',
                fullName: document.getElementById('edit-fullName').value,
                email: document.getElementById('edit-email').value,
                phone: document.getElementById('edit-phone').value,
                dob: document.getElementById('edit-dob').value,
                sex: document.getElementById('edit-sex').value,
                height: document.getElementById('edit-height').value,
                weight: document.getElementById('edit-weight').value,
                ethnicity: document.getElementById('edit-ethnicity').value,
                notes: document.getElementById('edit-notes').value
            };
        
            if (!customerData.fullName || !customerData.email) {
                alert("Please fill in at least Full Name and Email.");
                return;
            }
        
            try {
                const response = await callAppsScript('saveCustomer', customerData);
                if (response.error) {
                    alert(response.error);
                    return;
                }
                closeCustomerModal();
                // Now start booking for this email
                startBookingForEmail(customerData.email);
            } catch (error) {
                console.error(error);
                alert("Error saving customer.");
            }
        }

        function closeCustomerModal() {
            document.getElementById('customer-modal').classList.add('hidden');
        }

        async function saveCustomer(e) {
            e.preventDefault();
            
            const customerData = {
                id: document.getElementById('edit-customer-id').value || Date.now().toString(),
                fullName: document.getElementById('edit-fullName').value,
                email: document.getElementById('edit-email').value,
                phone: document.getElementById('edit-phone').value,
                dob: document.getElementById('edit-dob').value,
                sex: document.getElementById('edit-sex').value,
                height: document.getElementById('edit-height').value,
                weight: document.getElementById('edit-weight').value,
                ethnicity: document.getElementById('edit-ethnicity').value,
                notes: document.getElementById('edit-notes').value
            };

            try {
                const response = await callAppsScript('saveCustomer', customerData);
                if (response.error) {
                    alert(response.error);
                } else {
                    closeCustomerModal();
                    loadBusinessCustomers(); // Refresh list
                }
            } catch (error) {
                console.error(error);
                alert("Error saving customer.");
            }
        }

        function loadAppointmentsSection() {
            const today = new Date();
            const dateInput = document.getElementById('bookings-date');
            dateInput.value = today.toISOString().split('T')[0];
            loadAppointmentsForDate(dateInput.value);
        }
        
        async function loadAppointmentsForDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            document.getElementById('bookings-date-display').textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const container = document.getElementById('bookings-list');
            container.innerHTML = '<div class="spinner"></div>';
        
            try {
                const response = await callAppsScript('getDailyAgenda', { date: date.toISOString() });
                const agenda = response.agenda || [];
                
                if (agenda.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No appointments found for this date.</p>';
                    return;
                }
        
                container.innerHTML = agenda.map((b) => {
                    const timeStr = new Date(b.time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const details = b.customer.details || {};
                    
                    let dobStr = '-';
                    if (details.dob) {
                        const dobDate = new Date(details.dob);
                        if (!isNaN(dobDate.getTime())) dobStr = `${String(dobDate.getMonth()+1).padStart(2,'0')}/${String(dobDate.getDate()).padStart(2,'0')}/${dobDate.getFullYear()}`;
                    }
        
                    let statusColor = 'bg-yellow-100 text-yellow-700';
                    if (b.customer.apptStatus === 'Completed') statusColor = 'bg-green-100 text-green-700';
                    else if (b.customer.apptStatus === 'Confirmed' || b.customer.apptStatus === 'Accepted') statusColor = 'bg-blue-100 text-blue-700';
                    
                    const guestColor = b.customer.guestStatus === 'Accepted' ? 'bg-green-50 text-green-600' : 
                                       b.customer.guestStatus === 'Declined' ? 'bg-red-50 text-red-600' : 
                                       b.customer.guestStatus === 'Maybe' ? 'bg-orange-50 text-orange-600' : 'bg-gray-50 text-gray-500';
        
                    // Encode data for edit button - use the calEventId from the agenda
                    const editDataAttr = b.calEventId ? `data-cal-event-id="${b.calEventId}"` : '';
        
                    return `
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center font-bold text-blue-600">${b.customer.name.split(' ').map(n=>n[0]).join('')}</div>
                                <div>
                                    <h3 class="font-bold">${b.customer.name}</h3>
                                    <p class="text-gray-500 text-sm">${b.customer.email}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-blue-500">${timeStr}</p>
                                <div class="flex gap-1 justify-end mt-1">
                                    <span class="text-xs px-2 py-0.5 rounded-full ${statusColor}">${b.customer.apptStatus}</span>
                                    <span class="text-xs px-2 py-0.5 rounded-full ${guestColor}">${b.customer.guestStatus}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mb-2">
                            <button onclick="toggleNoteExpand(this)" class="text-xs text-blue-500 hover:underline focus:outline-none">
                                Show Details
                            </button>
                            <button onclick="openEditAppointmentModal('${b.customer.email}', '${encodeURIComponent(b.customer.services)}', '${encodeURIComponent(b.title)}', '${new Date(b.time).toISOString()}')" class="text-xs text-orange-500 hover:underline focus:outline-none">
                                 Edit
                            </button>
                            ${b.customer.poUrl ? `<a href="${b.customer.poUrl}" target="_blank" class="text-xs px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700 font-bold hover:bg-indigo-200 no-underline">PO</a>` : ''}
                        </div>
                        
                        <div class="notes-content hidden grid md:grid-cols-4 gap-4 text-sm mb-2">
                            <div><span class="text-gray-500">Phone:</span> <span class="font-medium">${b.customer.phone || '-'}</span></div>
                            <div><span class="text-gray-500">Sex:</span> <span class="font-medium">${details.sex || '-'}</span></div>
                            <div><span class="text-gray-500">DOB:</span> <span class="font-medium">${dobStr}</span></div>
                            <div><span class="text-gray-500">Height:</span> <span class="font-medium">${details.height || '-'}</span></div>
                            <div><span class="text-gray-500">Weight:</span> <span class="font-medium">${details.weight || '-'}</span></div>
                            <div><span class="text-gray-500">Ethnicity:</span> <span class="font-medium">${details.ethnicity || '-'}</span></div>
                        </div>
                        
                        <div class="border-t border-gray-100 pt-2 mt-2 text-sm">
                            <div class="flex gap-6 mb-1">
                                <div class="flex-1"><span class="text-gray-500 font-semibold">Services:</span> <span class="text-blue-700 font-medium">${b.customer.services}</span></div>
                            </div>
                            <div class="flex gap-6">
                                <div class="flex-1"><span class="text-gray-500 font-semibold">Cust. Notes:</span> <span class="text-gray-700">${details.notes || '-'}</span></div>
                                <div class="flex-1"><span class="text-gray-500 font-semibold">Appt. Notes:</span> <span class="text-red-600">${b.customer.apptNote || 'None'}</span></div>
                            </div>
                        </div>
                    </div>
                `}).join('');
        
            } catch (e) {
                console.error(e);
                container.innerHTML = '<p class="text-red-500">Error loading bookings.</p>';
            }
        }
        
        // Helper for toggle
        function toggleNoteExpand(btn) {
            // Find parent wrapper div, then find the next sibling with class 'notes-content'
            const wrapper = btn.closest('.flex.gap-2') || btn.parentElement;
            const content = wrapper.nextElementSibling;
            if (content && content.classList.contains('notes-content')) {
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    btn.textContent = 'Hide Details';
                } else {
                    content.classList.add('hidden');
                    btn.textContent = 'Show Details';
                }
            }
        }
        
        async function loadBusinessQuestions() {
            const container = document.getElementById('questions-list');
            container.innerHTML = '<div class="col-span-3 text-center py-8"><div class="spinner"></div></div>';
            
            try {
                const response = await callAppsScript('getQuestionsList');
                const questions = response.questions || [];
                
                container.innerHTML = questions.map(q => `
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex items-start justify-between mb-2">
                            <h3 class="font-bold">${q.text}</h3>
                            <div class="flex gap-1">
                                <button onclick="editQuestion('${q.id}')" class="p-1 hover:bg-gray-100 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>
                                <button onclick="deleteQuestion('${q.id}')" class="p-1 hover:bg-red-50 rounded text-red-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 flex gap-2">
                            <span class="px-2 py-1 bg-gray-100 rounded">${q.type}</span>
                            <span class="px-2 py-1 bg-gray-100 rounded">${q.ask}</span>
                            ${q.required ? '<span class="px-2 py-1 bg-blue-100 text-blue-600 rounded">Required</span>' : ''}
                        </div>
                    </div>
                `).join('');
                
                state.questionsList = questions;
            } catch (e) {
                container.innerHTML = '<p class="text-red-500">Error loading questions</p>';
            }
        }
        
        function openQuestionModal(id = null) {
            document.getElementById('question-modal').classList.remove('hidden');
            document.getElementById('question-form').reset();
            document.getElementById('question-id').value = '';
            
            if (id) {
                const q = state.questionsList.find(x => x.id === id);
                if (q) {
                    document.getElementById('question-id').value = q.id;
                    document.getElementById('question-text').value = q.text;
                    document.getElementById('question-type').value = q.type;
                    document.getElementById('question-ask').value = q.ask;
                    document.getElementById('question-required').checked = q.required;
                }
            }
        }
        
        function closeQuestionModal() { document.getElementById('question-modal').classList.add('hidden'); }
        
        function editQuestion(id) { openQuestionModal(id); }
        
        async function deleteQuestion(id) {
            if(!confirm('Delete this question?')) return;
            await callAppsScript('deleteQuestion', { id });
            loadBusinessQuestions();
        }
        
        async function saveQuestionData(e) {
            e.preventDefault();
            const data = {
                id: document.getElementById('question-id').value || generateId(),
                text: document.getElementById('question-text').value,
                type: document.getElementById('question-type').value,
                ask: document.getElementById('question-ask').value,
                required: document.getElementById('question-required').checked
            };
            await callAppsScript('saveQuestion', data);
            closeQuestionModal();
            loadBusinessQuestions();
        }
        
        async function loadDiscounts() {
            try {
                const response = await callAppsScript('getDiscounts');
                state.allDiscounts = response.discounts || [];
            } catch (e) {
                console.error("Error loading discounts", e);
                state.allDiscounts = [];
            }
        }

        async function loadCheckoutSection() {
            const today = new Date();
            document.getElementById('checkout-date').value = today.toISOString().split('T')[0];
            
            // Load services if not present (needed for base/addon prices)
            if (!state.services || state.services.length === 0) {
                // We reuse the hardcoded list or fetch if you have a backend call
                // For now, assuming HARDCODED_SERVICES is available or we fetch
                state.services = HARDCODED_SERVICES.map(s => ({
                    ...s,
                    price: parseFloat(s.price),
                    addonPrice: parseFloat(s.addonPrice),
                    duration: parseInt(s.duration),
                    addonDuration: parseInt(s.addonDuration),
                    id: s.id
                }));
            }
        
            // Load discounts if not already loaded
            if (!state.allDiscounts) await loadDiscounts();
            
            loadCheckoutAppointments(today.toISOString().split('T')[0]);
        }
        
        // 2. Calculate Breakdown Logic
        function calculateCheckoutBreakdown() {
            // A. Flatten Services from selected appointments
            let services = [];
            state.checkoutSelected.forEach(id => {
                const appt = state.checkoutAppointments.find(a => a.id === id);
                if (appt) {
                    const names = appt.service.split(',').map(s => s.trim());
                    names.forEach(name => {
                        // Find service definition
                        const sDef = state.services.find(s => s.name === name);
                        if (sDef) services.push({...sDef, apptId: id});
                        else {
                            // Fallback if service not found in definitions (use logged price as base)
                            services.push({
                                name: name,
                                price: appt.price, // Fallback
                                addonPrice: appt.price,
                                id: 'unknown'
                            });
                        }
                    });
                }
            });
        
            // B. Calculate Original Price (#1)
            let originalTotal = services.reduce((sum, s) => sum + (s.price || 0), 0);
        
            // C. Determine Paid Service Count (Excluding Consultation)
            const isConsultation = (s) => s.id === CONSULTATION_ID || s.name.includes("Consultation");
            const paidServices = services.filter(s => !isConsultation(s));
            const consultationServices = services.filter(s => isConsultation(s));
            
            // D. Calculate Bundled Price (Internal calculation for savings)
            let bundledPrice = 0;
            
            // Paid Services Logic
            if (paidServices.length >= 2) {
                paidServices.forEach(s => bundledPrice += (s.addonPrice || s.price));
            } else {
                paidServices.forEach(s => bundledPrice += s.price);
            }
            
            // Consultation Logic
            consultationServices.forEach(s => {
                if (paidServices.length >= 1) {
                    bundledPrice += (s.addonPrice || 0); // Free (usually 0)
                } else {
                    bundledPrice += s.price; // Standalone price
                }
            });
        
            // E. Bundled Savings (#2)
            let bundledSavings = originalTotal - bundledPrice;
        
            // F. Credits Logic (#3)
            // We iterate selected appointments and sum the value of credits found
            let creditsUsedVal = 0;
            
            // We need to match credits to services. 
            // We'll use the same logic as the booking form: Sort by price desc, apply credit if name matches.
            let sortedServices = [...services].sort((a, b) => (b.price || 0) - (a.price || 0));
            let availableCredits = JSON.parse(JSON.stringify(state.credits || [])); 
        
            sortedServices.forEach(s => {
                // Find credit matching service name
                const creditIdx = availableCredits.findIndex(c => 
                    c.name.toLowerCase() === s.name.toLowerCase() && c.used < 1
                );
                
                if (creditIdx > -1) {
                    // Credit covers the base price of the service
                    creditsUsedVal += (s.price || 0); 
                    availableCredits[creditIdx].used = 1; // Mark used for this calc
                }
            });
        
            // G. Gift Card Logic (#4)
            let subtotalBeforeGC = Math.max(0, bundledPrice - creditsUsedVal);
            let giftCardUsedVal = 0;
            
            const activeGC = state.giftCards.find(gc => gc.used < 1 && gc.name.toLowerCase() === 'gc');
            if (activeGC) {
                giftCardUsedVal = Math.min(subtotalBeforeGC, activeGC.value);
            }
        
            // H. Subtotal (#5)
            let calculatedSubtotal = Math.max(0, subtotalBeforeGC - giftCardUsedVal);
        
            return {
                original: originalTotal,
                bundledSavings: bundledSavings,
                creditsUsed: creditsUsedVal,
                giftCardUsed: giftCardUsedVal,
                subtotal: calculatedSubtotal
            };
        }
        
        function filterDiscounts(query) {
            const container = document.getElementById('discount-list-container');
            const q = query.toLowerCase();
            
            const filtered = state.allDiscounts.filter(d => 
                d.name.toLowerCase().includes(q) || 
                d.code.toLowerCase().includes(q)
            );
        
            if (filtered.length === 0) {
                container.innerHTML = '<div class="p-3 text-gray-500 text-sm">No matches found</div>';
            } else {
                container.innerHTML = filtered.map(d => `
                    <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0" onclick="selectDiscount('${d.code}', '${d.name}', '${d.type}', ${d.value})">
                        <div class="font-semibold text-gray-800">${d.name}</div>
                        <div class="text-xs text-gray-500">Code: ${d.code} | ${d.type === 'percent' ? d.value + '%' : '$' + d.value} off</div>
                    </div>
                `).join('');
            }
            
            container.classList.remove('hidden');
        }
        
        function showDiscountList() {
            filterDiscounts(document.getElementById('discount-search-input').value);
        }
        
        // 4. Handle Selection
        function selectDiscount(code, name, type, value) {
            document.getElementById('discount-code').value = code;
            document.getElementById('discount-search-input').value = name; // Show name in search bar
            document.getElementById('discount-list-container').classList.add('hidden');
            
            state.appliedDiscount = { name, type, value, code };
            
            // Show applied badge
            const display = document.getElementById('applied-discount-display');
            document.getElementById('applied-discount-text').textContent = `Applied: ${name} (${code})`;
            display.classList.remove('hidden');
            
            updateCheckoutSummary();
        }
        
        function clearDiscount() {
            state.appliedDiscount = null;
            document.getElementById('discount-code').value = '';
            document.getElementById('discount-search-input').value = '';
            document.getElementById('applied-discount-display').classList.add('hidden');
            updateCheckoutSummary();
        }
        
        function filterModalDiscounts(query) {
            const container = document.getElementById('modal-discount-list');
            const q = query.toLowerCase();
            const filtered = state.allDiscounts.filter(d => !d.isExpired && (d.name.toLowerCase().includes(q) || d.code.toLowerCase().includes(q)));
            if (filtered.length === 0) { container.innerHTML = '<div class="p-3 text-gray-500 text-sm">No matches</div>'; }
            else {
                container.innerHTML = filtered.map(d => `
                    <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100" onclick="selectModalDiscount('${d.id}', '${d.name}', '${d.type}', ${d.value})">
                        <div class="font-semibold text-gray-800">${d.name}</div>
                        <div class="text-xs text-gray-500">${d.type === 'percent' ? d.value + '%' : '$' + d.value} off</div>
                    </div>
                `).join('');
            }
            container.classList.remove('hidden');
        }
        
        function showModalDiscountList() { filterModalDiscounts(document.getElementById('modal-discount-search').value); }
        
        function selectModalDiscount(id, name, type, value) {
            state.checkoutDiscount = { id, name, type, value };
            document.getElementById('modal-discount-search').value = name;
            document.getElementById('modal-discount-list').classList.add('hidden');
            document.getElementById('modal-applied-text').textContent = `${name} Applied`;
            document.getElementById('modal-applied-discount').classList.remove('hidden');
            recalcCheckoutTotal();
        }
        
        function clearModalDiscount() {
            state.checkoutDiscount = null;
            document.getElementById('modal-discount-search').value = '';
            document.getElementById('modal-applied-discount').classList.add('hidden');
            recalcCheckoutTotal();
        }
        function toggleModalOverride() { document.getElementById('modal-override-container').classList.toggle('hidden'); }
        
        function applyModalOverride(val) {
            const num = parseFloat(val);
            state.checkoutManualOverride = (!isNaN(num) && num >= 0) ? num : null;
            recalcCheckoutTotal();
        }

        async function loadCheckoutAppointments(dateStr) {
            const container = document.getElementById('checkout-appointments');
            container.innerHTML = '<div class="spinner"></div>';
        
            try {
                const response = await callAppsScript('getAppointments', { date: dateStr });
                state.checkoutAppointments = response.appointments || [];
                
                state.checkoutSelected = [];
        
                if (state.checkoutAppointments.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No appointments found for this date.</p>';
                    return;
                }
        
                container.innerHTML = state.checkoutAppointments.map(appt => {
                    let timeDisplay = appt.time;
                    if (appt.time && appt.time.includes('T')) {
                        timeDisplay = new Date(appt.time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    }
                    
                    // Status Badge Logic
                    let statusClass = 'bg-yellow-100 text-yellow-700'; // Scheduled
                    if (appt.status === 'Completed') statusClass = 'bg-green-100 text-green-700';
                    else if (appt.status === 'Confirmed') statusClass = 'bg-blue-100 text-blue-700';
                    
                    return `
                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <input type="checkbox" class="checkbox-custom" onchange="toggleCheckoutSelection('${appt.id}', this.checked)">
                        <div class="flex-1">
                            <div class="font-semibold">${appt.name}</div>
                            <div class="text-sm text-gray-500">${appt.service} - <span class="font-bold text-blue-600">${timeDisplay}</span></div>
                        </div>
                        <div class="text-right flex flex-col items-end gap-1">
                            <div class="font-bold">$${parseFloat(appt.price).toFixed(2)}</div>
                            <span class="text-xs px-2 py-0.5 rounded-full ${statusClass}">${appt.status}</span>
                        </div>
                    </div>
                `}).join('');
        
            } catch (e) {
                console.error(e);
                container.innerHTML = '<p class="text-red-500">Error loading appointments.</p>';
            }
        }

        function toggleCheckoutSelection(apptId, selected) {
            // Ensure array exists
            if (!state.checkoutSelected) state.checkoutSelected = [];
        
            const numericId = parseInt(apptId);
            
            if (selected) {
                if (!state.checkoutSelected.includes(numericId)) {
                    state.checkoutSelected.push(numericId);
                }
            } else {
                state.checkoutSelected = state.checkoutSelected.filter(id => id !== numericId);
            }
            
            updateCheckoutSummary();
        }

        function toggleManualOverride() {
            const container = document.getElementById('manual-override-container');
            container.classList.toggle('hidden');
        }
        
        function applyManualOverride(value) {
            const val = parseFloat(value);
            const totalEl = document.getElementById('checkout-total');
            
            if (!isNaN(val) && val >= 0) {
                totalEl.textContent = `$${val.toFixed(2)}`;
                totalEl.classList.add('text-yellow-600'); // Highlight that it's modified
                state.checkoutTotal = val;
                state.manualOverride = val;
            } else {
                // Revert to calculated
                updateCheckoutSummary(); 
                state.manualOverride = null;
            }
        }


        function updateCheckoutSummary() {
            const summary = document.getElementById('checkout-summary');
            const subtotalEl = document.getElementById('checkout-subtotal');
            const totalEl = document.getElementById('checkout-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            
            // Safety check for elements
            if (!summary || !subtotalEl || !totalEl || !checkoutBtn) return;
        
            if (state.checkoutSelected.length === 0) {
                summary.innerHTML = '<p class="text-gray-500 text-sm">Select appointments to checkout</p>';
                subtotalEl.textContent = '$0.00';
                totalEl.textContent = '$0.00';
                checkoutBtn.disabled = true;
                return;
            }
        
            let subtotal = 0;
            let html = '';
            
            state.checkoutSelected.forEach(id => {
                const appt = state.checkoutAppointments.find(a => a.id === id);
                if (appt) {
                    const price = parseFloat(appt.price) || 0;
                    subtotal += price;
                    html += `
                        <div class="flex justify-between text-sm mb-1">
                            <span>${appt.name}</span>
                            <span>$${price.toFixed(2)}</span>
                        </div>
                    `;
                }
            });
        
            summary.innerHTML = html;
            subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            totalEl.textContent = `$${subtotal.toFixed(2)}`;
            
            // Enable the "Continue" button which opens the modal
            checkoutBtn.disabled = false;
        }

        async function applyDiscount() {
            const code = document.getElementById('discount-code').value.trim();
            if (!code) return;

            try {
                const response = await callAppsScript('validateDiscount', { code });
                if (response.valid) {
                    state.appliedDiscount = response.discount;
                    updateCheckoutSummary();
                    alert(`Discount applied: ${response.discount.name}`);
                } else {
                    alert('Invalid discount code');
                }
            } catch (error) {
                    alert('Invalid discount code - Unverified');
            }
        }

        async function initiateCheckout() {
            if (state.checkoutSelected.length === 0) {
                alert("Please select appointments.");
                return;
            }
        
            // 1. Identify unique customers
            const customers = [];
            state.checkoutSelected.forEach(id => {
                const a = state.checkoutAppointments.find(appt => appt.id === id);
                if (a) {
                    if (!customers.find(c => c.email === a.email)) {
                        customers.push({ name: a.name, email: a.email });
                    }
                }
            });
        
            if (customers.length > 1) {
                showPayerSelectionModal(customers);
            } else {
                openCheckoutModal(customers[0]);
            }
        }

        
        function showPayerSelectionModal(customers) {
            const container = document.getElementById('payer-options');
            container.innerHTML = customers.map(c => `
                <button onclick="openCheckoutModal({name: '${c.name}', email: '${c.email}'})" class="w-full p-4 text-left bg-gray-50 rounded-xl hover:bg-blue-50 transition-colors border border-gray-200">
                    <div class="font-semibold">${c.name}</div>
                    <div class="text-sm text-gray-500">${c.email}</div>
                </button>
            `).join('');
            document.getElementById('payer-modal').classList.remove('hidden');
        }
        
        async function openCheckoutModal(payer) {
            state.creditingCustomers = [];
            document.getElementById('crediting-customer-list').innerHTML = '';
            document.getElementById('crediting-customer-email').value = '';
            document.getElementById('payer-modal').classList.add('hidden');
            
            // 1. Setup State
            state.checkoutPayer = payer;
            state.checkoutCreditsUsed = {}; 
            state.checkoutGCInputs = {}; // Map: "Customer Email" -> Amount
            state.checkoutDiscount = null;
            state.checkoutManualOverride = null;
        
            // Reset UI
            document.getElementById('modal-discount-search').value = '';
            document.getElementById('modal-applied-discount').classList.add('hidden');
            document.getElementById('checkout-notes-input').value = '';
            document.getElementById('modal-override-container').classList.add('hidden');
            document.getElementById('modal-override-input').value = '';
            document.getElementById('gc-error-text').classList.add('hidden');
            
            // 2. Gather Emails
            const allEmails = [...new Set(state.checkoutSelected.map(id => {
                const a = state.checkoutAppointments.find(appt => appt.id === id);
                return a ? a.email : null;
            }).filter(e => e))];
        
            // 3. Fetch Data
            const response = await callAppsScript('getCheckoutData', { emails: allEmails });
            state.checkoutAvailableCredits = response.credits || [];
            state.checkoutAvailableGCs = response.giftCards || [];
        
            // 4. Populate UI
            document.getElementById('checkout-payer-name').textContent = `${payer.name} (${payer.email})`;
            
            renderCheckoutServices();
            renderGiftCardInputs();
            
            document.getElementById('checkout-process-modal').classList.remove('hidden');
            recalcCheckoutTotal();
        }
        
        function renderGiftCardInputs() {
            const container = document.getElementById('gc-inputs-container');
            
            const gcByPerson = {};
            state.checkoutAvailableGCs.forEach(gc => {
                if (!gcByPerson[gc.customerName]) {
                    gcByPerson[gc.customerName] = {
                        email: gc.customerEmail,
                        total: 0
                    };
                }
                gcByPerson[gc.customerName].total += gc.value;
            });
        
            const persons = Object.keys(gcByPerson);
            
            if (persons.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center">No Gift Cards available.</p>';
                return;
            }
        
            container.innerHTML = persons.map(name => {
                const data = gcByPerson[name];
                return `
                    <div class="flex items-center justify-between bg-white p-2 rounded border">
                        <div>
                            <span class="font-medium text-sm">${name}</span>
                            <span class="text-xs text-gray-400 block">Avail: $${data.total.toFixed(2)}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span>$</span>
                            <input type="number" 
                                   class="input-field w-20 text-sm py-1 text-right" 
                                   placeholder="0.00" 
                                   min="0" 
                                   step="0.01"
                                   max="${data.total}"
                                   data-email="${data.email}" 
                                   data-max="${data.total}"
                                   oninput="validateAndUpdateGC(this)">
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function validateAndUpdateGC(input) {
            let val = parseFloat(input.value) || 0;
            const max = parseFloat(input.dataset.max) || 0;
            
            // 1. Enforce Positive
            if (val < 0) val = 0;
            
            // 2. Enforce Max
            if (val > max) val = max;
            
            input.value = val;
            
            const email = input.dataset.email;
            state.checkoutGCInputs[email] = val;
            
            recalcCheckoutTotal();
        }
                
        function updateGCInput(input) {
            const email = input.dataset.email;
            const val = parseFloat(input.value) || 0;
            state.checkoutGCInputs[email] = val;
            recalcCheckoutTotal();
        }
        
        function renderCheckoutServices() {
            const container = document.getElementById('checkout-service-list');
            let allServices = [];
            
            state.checkoutSelected.forEach(id => {
                const a = state.checkoutAppointments.find(appt => appt.id === id);
                if (a) {
                    const names = a.service.split(',').map(s => s.trim());
                    names.forEach(name => {
                        const sDef = state.services.find(s => s.name === name);
                        allServices.push({
                            name: name,
                            price: parseFloat(sDef ? sDef.price : 0),
                            addonPrice: parseFloat(sDef ? sDef.addonPrice : 0),
                            customerName: a.name,
                            customerEmail: a.email,
                            id: sDef ? sDef.id : 'unknown'  // normalize ID to string here too
                        });
                    });
                }
            });
        
            state.checkoutServicesFlat = allServices;
            
            // 1. Count Class A services in this specific checkout list
            const countA = allServices.filter(s => {
                if (s.id && CLASS_A_IDS.includes(s.id)) return true;
                const name = s.name.toLowerCase();
                return name.includes('dexa') || name.includes('rmr') || name.includes('vo2');
            }).length;
            
            // 2. Render Services with Visual Logic
            container.innerHTML = allServices.map((s, idx) => {
                const isClassA = (s.id && CLASS_A_IDS.includes(s.id)) || 
                                 (s.name.toLowerCase().includes('dexa') || s.name.toLowerCase().includes('rmr') || s.name.toLowerCase().includes('vo2'));
                
                let displayPrice = s.price;
                let originalPrice = null; // For strikethrough
                let isBundleActive = false;
                
                // Apply Pricing Rules
                if (countA >= 2) {
                    // Rule 4 & 5: All Addon
                    isBundleActive = true;
                    displayPrice = (s.addonPrice !== undefined && s.addonPrice !== null) ? s.addonPrice : s.price;
                    if (displayPrice !== s.price) originalPrice = s.price;
                } else if (countA === 1) {
                    if (isClassA) {
                        // Rule 2: The One Class A is Base
                        isBundleActive = false;
                        displayPrice = s.price;
                    } else {
                        // Rule 2: Class B is Addon
                        isBundleActive = true;
                        displayPrice = (s.addonPrice !== undefined && s.addonPrice !== null) ? s.addonPrice : s.price;
                        if (displayPrice !== s.price) originalPrice = s.price;
                    }
                } else {
                    // Rule 3: All Base
                    isBundleActive = false;
                    displayPrice = s.price;
                }
                
                const priceHtml = originalPrice !== null 
                    ? `<s class="text-gray-400 mr-1">$${originalPrice.toFixed(2)}</s><span class="text-blue-600 font-bold">$${displayPrice.toFixed(2)}</span>`
                    : `<span class="font-bold">$${displayPrice.toFixed(2)}</span>`;
        
                return `
                <div class="p-3 bg-gray-50 rounded-lg border ${isBundleActive ? 'border-blue-200 bg-blue-50' : ''}">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${s.name}</p>
                            <p class="text-xs text-gray-500">${s.customerName}</p>
                        </div>
                        <div class="text-right">
                            ${priceHtml}
                        </div>
                    </div>
                    <div class="mt-2" id="credit-select-container-${idx}">
                        <!-- Dynamic Dropdown inserted here -->
                    </div>
                </div>
                `;
            }).join('');
        
            // Populate dropdowns dynamically
            updateCreditDropdowns();
        }
        
        function updateCreditDropdowns() {
            const services = state.checkoutServicesFlat || [];
            
            services.forEach((s, idx) => {
                const container = document.getElementById(`credit-select-container-${idx}`);
                if (!container) return;
        
                // 1. Find matching credits for this service name
                const matchingCredits = state.checkoutAvailableCredits.filter(c => 
                    c.name.toLowerCase() === s.name.toLowerCase()
                );
        
                if (matchingCredits.length === 0) {
                    container.innerHTML = ''; // No credits available
                    return;
                }
        
                // 2. Build Options
                let options = `<option value="">No Credit Applied</option>`;
                
                matchingCredits.forEach(c => {
                    // Calculate how many of THIS credit ID are already used globally
                    const usedCount = Object.values(state.checkoutCreditsUsed).filter(id => id == c.id).length;
                    // Available = Total Value - Used Count
                    const availableQty = Math.floor(c.value) - usedCount;
        
                    // Is this specific service line item using this credit?
                    const isUsedHere = state.checkoutCreditsUsed[idx] == c.id;
        
                    // Only show option if available > 0 OR if it's the one currently selected here
                    if (availableQty > 0 || isUsedHere) {
                        const exp = c.expiration ? new Date(c.expiration).toLocaleDateString() : 'N/A';
                        options += `<option value="${c.id}" ${isUsedHere ? 'selected' : ''}>
                            Use Credit (${c.customerName}) - Exp: ${exp} (Qty: ${isUsedHere ? availableQty + 1 : availableQty})
                        </option>`;
                    }
                });
        
                container.innerHTML = `
                    <select class="input-field text-xs py-1 px-2 w-full bg-white border-blue-200" onchange="selectCredit(${idx}, this.value)">
                        ${options}
                    </select>
                `;
            });
        }


        
        function selectCredit(serviceIdx, creditId) {
            if (!state.checkoutCreditsUsed) state.checkoutCreditsUsed = {};
        
            if (creditId && creditId !== "") {
                state.checkoutCreditsUsed[serviceIdx] = creditId;
            } else {
                delete state.checkoutCreditsUsed[serviceIdx];
            }
            
            // Re-render dropdowns to update available quantities visually
            updateCreditDropdowns();
            // Recalc totals
            recalcCheckoutTotal();
        }
        
                function recalcCheckoutTotal() {
            const services = state.checkoutServicesFlat || [];
            if (services.length === 0) {
                 document.getElementById('co-original').textContent = `$0.00`;
                 document.getElementById('co-bundle-savings').textContent = `$0.00`;
                 document.getElementById('co-credit-savings').textContent = `$0.00`;
                 document.getElementById('co-gc-savings').textContent = `$0.00`;
                 document.getElementById('co-discount-savings').textContent = `$0.00`;
                 document.getElementById('co-final-total').textContent = `$0.00`;
                 state.checkoutFinalTotal = 0;
                 return;
            }

            // 1. Classify Services
            // FIX: Convert ID to String for reliable comparison against CLASS_A_IDS strings.
            // FIX: Use .toLowerCase() for name checks to fix VO2 detection.
            const classA = services.filter(s => {
                const idStr = s.id;
                if (CLASS_A_IDS.includes(idStr)) return true;
                
                // Fallback name match
                const name = s.name.toLowerCase();
                return name.includes('dexa') || name.includes('rmr') || name.includes('vo2');
            });
            
            const countA = classA.length;
            console.log('Services:', services.map(s => ({name: s.name, id: s.id, price: s.price, addonPrice: s.addonPrice})));
            console.log('countA:', countA);
            
            // 2. Calculate Bundle Totals
            let bundleTotal = 0;
            let originalTotal = 0;
            
            services.forEach(s => {
                const basePrice = parseFloat(s.price) || 0;
                const addonPrice = (s.addonPrice !== undefined && s.addonPrice !== null) 
                    ? parseFloat(s.addonPrice) 
                    : basePrice;
                
                originalTotal += basePrice;
                
                const isClassA = (s.id && CLASS_A_IDS.includes(s.id)) || 
                                 ((s.name || '').toLowerCase().includes('dexa') || 
                                  (s.name || '').toLowerCase().includes('rmr') || 
                                  (s.name || '').toLowerCase().includes('vo2'));
                
                let currentPrice = basePrice;
                
                if (countA >= 2) {
                    currentPrice = addonPrice;
                } else if (countA === 1) {
                    currentPrice = isClassA ? basePrice : addonPrice;
                }
                
                bundleTotal += currentPrice;
            });
            
            const bundleSavings = originalTotal - bundleTotal;

            // 3. Calculate Credit Savings
            let creditSavings = 0;
            Object.entries(state.checkoutCreditsUsed).forEach(([idx, creditId]) => {
                const s = services[idx];
                const c = state.checkoutAvailableCredits.find(x => x.id == creditId);
                if (s && c && c.name.toLowerCase() === s.name.toLowerCase()) {
                    creditSavings += (s.price || 0);
                }
            });

            // 4. Calculate GC Savings
            let gcSavings = 0;
            if(state.checkoutGCInputs) {
                Object.values(state.checkoutGCInputs).forEach(val => gcSavings += (parseFloat(val) || 0));
            }

            // 5. Discount
            let discountVal = 0;
            if (state.checkoutDiscount) {
                const subForDisc = Math.max(0, bundleTotal - creditSavings - gcSavings);
                if (state.checkoutDiscount.type === 'percent') discountVal = subForDisc * (state.checkoutDiscount.value / 100);
                else discountVal = state.checkoutDiscount.value;
            }

            // 6. Final
            let finalTotal = Math.max(0, bundleTotal - creditSavings - gcSavings - discountVal);

            if (state.checkoutManualOverride !== null && state.checkoutManualOverride >= 0) {
                finalTotal = state.checkoutManualOverride;
            }

            // Update UI
            document.getElementById('co-original').textContent = `$${originalTotal.toFixed(2)}`;
            document.getElementById('co-bundle-savings').textContent = `-$${bundleSavings.toFixed(2)}`;
            document.getElementById('co-credit-savings').textContent = `-$${creditSavings.toFixed(2)}`;
            document.getElementById('co-gc-savings').textContent = `-$${gcSavings.toFixed(2)}`;
            document.getElementById('co-discount-savings').textContent = `-$${discountVal.toFixed(2)}`;
            
            const totalEl = document.getElementById('co-final-total');
            totalEl.textContent = `$${finalTotal.toFixed(2)}`;
            totalEl.classList.toggle('text-yellow-600', state.checkoutManualOverride !== null);

            state.checkoutFinalTotal = finalTotal;
            state.checkoutSavings = {
                total: bundleSavings + creditSavings + gcSavings + discountVal,
                bundle: bundleSavings,
                credits: creditSavings,
                gc: gcSavings,
                discount: discountVal
            };
        }
        
        function closeCheckoutModal() {
            document.getElementById('checkout-process-modal').classList.add('hidden');
        }
        
        // Hide discount list on outside click
        document.addEventListener('click', function(e) {
            const container = document.getElementById('modal-discount-list');
            const input = document.getElementById('modal-discount-search');
            if (container && !container.contains(e.target) && e.target !== input) {
                container.classList.add('hidden');
            }
        });
        
        async function loadCreditManagement() {
            const tbody = document.getElementById('credits-table-body');
            const container = document.getElementById('credits-list-container');
            
            state.creditPage = 0;
            state.creditSearch = '';
            
            // Robustly ensure "Load More" button exists
            let loadMoreDiv = document.getElementById('load-more-credits-btn');
            if (!loadMoreDiv && container) {
                loadMoreDiv = document.createElement('div');
                loadMoreDiv.id = 'load-more-credits-btn';
                loadMoreDiv.className = 'p-4 text-center hidden';
                loadMoreDiv.innerHTML = '<button onclick="loadMoreCredits()" class="btn-secondary">Load More</button>';
                container.appendChild(loadMoreDiv);
            }
            
            tbody.innerHTML = '<tr><td colspan="6" class="text-center p-8">Loading...</td></tr>';
        
            try {
                const response = await callAppsScript('getCreditManagement', { page: state.creditPage, search: '' });
                state.creditItems = response.items || [];
                
                renderCreditRows(state.creditItems);
                if (loadMoreDiv) loadMoreDiv.classList.toggle('hidden', !response.hasMore);
        
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-red-500">Error loading data.</td></tr>';
            }
        }
        
        async function searchCredits(query) {
            state.creditSearch = query;
            state.creditPage = 0;
            
            const tbody = document.getElementById('credits-table-body');
            const loadMoreDiv = document.getElementById('load-more-credits-btn');
            
            tbody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">Searching...</td></tr>';
            
            try {
                const response = await callAppsScript('getCreditManagement', { page: state.creditPage, search: query });
                state.creditItems = response.items || [];
                
                renderCreditRows(state.creditItems);
                if (loadMoreDiv) loadMoreDiv.classList.toggle('hidden', !response.hasMore);
                
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-red-500">Error searching.</td></tr>';
            }
        }
        
        async function loadMoreCredits() {
            state.creditPage++;
            const btn = document.querySelector('#load-more-credits-btn button');
            if(!btn) return;
            
            btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div>';
            
            try {
                const response = await callAppsScript('getCreditManagement', { page: state.creditPage, search: state.creditSearch });
                const newItems = response.items || [];
                
                state.creditItems = [...state.creditItems, ...newItems];
                renderCreditRows(newItems);
                
                btn.innerHTML = 'Load More';
                const container = document.getElementById('load-more-credits-btn');
                if (container) container.classList.toggle('hidden', !response.hasMore);
            } catch (e) {
                console.error(e);
                btn.innerHTML = 'Load More';
            }
        }
        
        function renderCreditRows(items) {
            const tbody = document.getElementById('credits-table-body');
            
            if (items.length === 0 && state.creditPage === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">No records found.</td></tr>';
                return;
            }
            
            const html = items.map(item => {
                const statusClass = item.status === 'Active' ? 'bg-green-100 text-green-700' : 
                                    item.status === 'Used' ? 'bg-gray-100 text-gray-500' : 'bg-red-100 text-red-700';
                
                let expDisplay = '-';
                if (item.expiration) {
                    try {
                        const d = new Date(item.expiration);
                        if (!isNaN(d.getTime())) expDisplay = d.toLocaleDateString('en-US');
                    } catch(e) { expDisplay = item.expiration; }
                }
        
                return `
                <tr class="border-b border-gray-50">
                    <td class="px-6 py-4">
                        <div class="font-medium">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.email}</div>
                    </td>
                    <td class="px-6 py-4 text-sm">${item.itemName}</td>
                    <td class="px-6 py-4 font-bold">${item.value}</td>
                    <td class="px-6 py-4 text-sm">${expDisplay}</td>
                    <td class="px-6 py-4"><span class="status-badge ${statusClass}">${item.status}</span></td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2">
                            <button onclick="adjustCreditValue('${item.id}', 'add')" class="text-green-600 hover:text-green-800 text-xs font-bold">+Add</button>
                            <button onclick="adjustCreditValue('${item.id}', 'remove')" class="text-red-600 hover:text-red-800 text-xs font-bold">-Rem</button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
            
            if(state.creditPage === 0) tbody.innerHTML = html;
            else tbody.insertAdjacentHTML('beforeend', html);
        }
        
        function openAddCreditModal() {
            document.getElementById('add-credit-modal').classList.remove('hidden');
            
            // Populate Service Dropdown
            const select = document.getElementById('new-cred-item');
            select.innerHTML = '<option value="gc">Gift Card (GC)</option>'; // Default GC option
            
            // Add services from state
            if(state.services) {
                state.services.forEach(s => {
                    select.innerHTML += `<option value="${s.name}">${s.name}</option>`;
                });
            }
        }
        
        function closeAddCreditModal() {
            document.getElementById('add-credit-modal').classList.add('hidden');
        }
        
        async function submitNewCredit(e) {
            e.preventDefault();
            const data = {
                email: document.getElementById('new-cred-email').value,
                customerName: document.getElementById('new-cred-name').value,
                itemName: document.getElementById('new-cred-item').value,
                value: document.getElementById('new-cred-value').value,
                expiration: document.getElementById('new-cred-exp').value
            };
        
            try {
                await callAppsScript('saveNewCredit', data);
                closeAddCreditModal();
                loadCreditManagement();
            } catch (err) {
                alert("Error saving: " + err.message);
            }
        }
        
        async function adjustCreditValue(id, operation) {
            const amountStr = prompt(`Enter amount to ${operation}:`);
            if (!amountStr) return;
            
            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount <= 0) {
                alert("Please enter a valid positive number.");
                return;
            }
        
            try {
                await callAppsScript('adjustCredit', { id: id, operation: operation, amount: amount });
                loadCreditManagement();
            } catch (e) {
                alert("Error: " + e.message);
            }
        }
        
        async function acceptPayment() {
            const btn = document.querySelector('#checkout-process-modal .btn-primary'); 
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Processing...';
        
            const deductionData = prepareDeductionData();
        
            try {
                await callAppsScript('deductCreditsAndGC', deductionData);
                
                const stripeData = {
                    payerEmail: state.checkoutPayer.email,
                    payerName: state.checkoutPayer.name,
                    total: state.checkoutFinalTotal,
                    notes: document.getElementById('checkout-notes-input').value,
                    parties: [...new Set(state.checkoutServicesFlat.map(s => s.customerName))],
                    savings: state.checkoutSavings,
                    manualOverride: state.checkoutManualOverride ? true : false,
                    servicesList: state.checkoutServicesFlat.map(s => ({ name: s.name, customer: s.customerName })),
                    appointmentIds: state.checkoutSelected // Pass IDs to mark Completed
                };
        
                const response = await callAppsScript('createCheckoutSession', stripeData);
                if (response.sessionId) {
                    const stripe = Stripe(CONFIG.STRIPE_PUBLIC_KEY);
                    await stripe.redirectToCheckout({ sessionId: response.sessionId });
                } else {
                    throw new Error(response.error || "Stripe error");
                }
            } catch (e) {
                alert("Error: " + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Accept Payment (Stripe)';
            }
        }
        
        async function acceptCash() {
            const btn = document.getElementById('accept-cash-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Processing...';
            
            const deductionData = prepareDeductionData();
            
            const cashData = {
                customers: [...new Set(state.checkoutServicesFlat.map(s => s.customerName))],
                services: state.checkoutServicesFlat.map(s => s.name),
                total: state.checkoutFinalTotal,
                notes: document.getElementById('checkout-notes-input').value,
                appointmentIds: state.checkoutSelected
            };
            
            try {
                await callAppsScript('deductCreditsAndGC', deductionData);
                await callAppsScript('acceptCash', cashData);
                
                alert("Cash transaction logged successfully!");
                // Reload the page to reflect 'Completed' status and clear state
                window.location.reload();
                
            } catch (e) {
                alert("Error logging cash transaction: " + e.message);
                btn.disabled = false;
                btn.innerHTML = 'Accept Cash';
            }
        }
        
        // Helper to prepare deduction payload used by both Stripe and Cash
        function prepareDeductionData() {
            const data = { credits: [], giftCards: [] };
            
            // Credits
            const usedCreditIds = new Set(Object.values(state.checkoutCreditsUsed));
            usedCreditIds.forEach(id => data.credits.push({ id: id, amount: 1 }));
        
            // GCs
            const gcByPerson = {};
            state.checkoutAvailableGCs.forEach(gc => {
                if (!gcByPerson[gc.customerEmail]) gcByPerson[gc.customerEmail] = [];
                gcByPerson[gc.customerEmail].push(gc);
            });
            Object.keys(gcByPerson).forEach(email => {
                gcByPerson[email].sort((a, b) => {
                    const da = a.expiration ? new Date(a.expiration) : new Date('9999-12-31');
                    const db = b.expiration ? new Date(b.expiration) : new Date('9999-12-31');
                    return da - db;
                });
            });
        
            for (const [email, amount] of Object.entries(state.checkoutGCInputs)) {
                let remaining = parseFloat(amount) || 0;
                if (remaining <= 0) continue;
                const personGCs = gcByPerson[email] || [];
                for (let gc of personGCs) {
                    if (remaining <= 0) break;
                    const deductAmt = Math.min(gc.value, remaining);
                    data.giftCards.push({ id: gc.id, amount: deductAmt });
                    remaining -= deductAmt;
                }
            }
            return data;
        }

        function closePayerModal() {
            document.getElementById('payer-modal').classList.add('hidden');
        }
        
        function selectPayer(email) {
            closePayerModal();
            processPayment(email); // Proceed with the selected payer
        }
        
        // ============================================
        // PACKAGES & MEMBERSHIPS LOGIC
        // ============================================
        
        async function showPackagesModal() {
            const email = document.getElementById('customer-email').value;
            if(!email) { alert("Please enter your email first."); return; }
            state.customerEmail = email;
        
            // Open Modal with Loading State
            document.getElementById('packages-modal').classList.remove('hidden');
            document.getElementById('packages-list-container').innerHTML = '<div class="text-center p-10"><div class="spinner"></div><p>Loading offers...</p></div>';
        
            try {
                const response = await callAppsScript('getPackages');
                state.allPackages = response.packages || [];
                togglePkgView('packages'); 
            } catch(e) {
                document.getElementById('packages-list-container').innerHTML = '<p class="text-red-500 text-center">Error loading packages.</p>';
            }
        }
        
        function closePackagesModal() {
            document.getElementById('packages-modal').classList.add('hidden');
        }
        
        function togglePkgView(view) {
            const btnPkg = document.getElementById('btn-toggle-packages');
            const btnMem = document.getElementById('btn-toggle-memberships');
            const link = document.getElementById('manage-membership-link');
        
            if (view === 'packages') {
                btnPkg.classList.add('bg-white', 'shadow');
                btnPkg.classList.remove('text-gray-500');
                btnMem.classList.remove('bg-white', 'shadow');
                btnMem.classList.add('text-gray-500');
                link.classList.add('hidden');
                renderPackageList('Package');
            } else {
                btnMem.classList.add('bg-white', 'shadow');
                btnMem.classList.remove('text-gray-500');
                btnPkg.classList.remove('bg-white', 'shadow');
                btnPkg.classList.add('text-gray-500');
                link.classList.remove('hidden');
                renderPackageList('Membership');
            }
        }
        
        function renderPackageList(type) {
            const container = document.getElementById('packages-list-container');
            
            // Safety Check
            if (!state.allPackages) {
                container.innerHTML = '<div class="text-center p-10"><div class="spinner"></div><p>Loading offers...</p></div>';
                return;
            }
        
            const filtered = state.allPackages.filter(p => p.type === type);
        
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">No ' + type + 's available.</p>';
                return;
            }
        
            container.innerHTML = filtered.map(p => `
                <div class="border border-gray-200 rounded-xl p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 hover:bg-gray-50 mb-3">
                    <div class="flex-1 w-full sm:w-auto pr-4">
                        <div class="flex justify-between items-start w-full">
                            <h3 class="font-bold text-lg">${p.name}</h3>
                            <!-- Show price next to name on mobile -->
                            <span class="font-bold text-blue-600 text-lg sm:hidden">$${p.price}</span>
                        </div>
                        
                        <!-- Description with Expansion Logic -->
                        <div class="mt-1">
                            <p class="text-sm text-gray-500 line-clamp-2">${p.description || ''}</p>
                            <button onclick="togglePackageDesc(this)" class="text-blue-500 text-xs mt-1 hover:underline focus:outline-none">
                                Show more
                            </button>
                        </div>
        
                        <!-- Show price on desktop -->
                        <div class="hidden sm:block text-lg font-bold text-blue-600 mt-2">$${p.price}</div>
                    </div>
                    <button onclick="buyPackage('${p.id}', '${p.type}', '${p.priceId}')" class="btn-primary px-6 py-2 rounded-lg text-sm w-full sm:w-auto whitespace-nowrap">
                        Buy Now
                    </button>
                </div>
            `).join('');
        }
        
        function togglePackageDesc(btn) {
            const descEl = btn.previousElementSibling; // The <p> tag
            
            if (descEl.classList.contains('line-clamp-2')) {
                descEl.classList.remove('line-clamp-2');
                btn.textContent = 'Show less';
            } else {
                descEl.classList.add('line-clamp-2');
                btn.textContent = 'Show more';
            }
        }
        
        async function buyPackage(pkgId, type, priceId) {
            const btn = event.target;
            btn.innerHTML = "Loading...";
            btn.disabled = true;
        
            try {
                const response = await callAppsScript('createPackageSession', {
                    email: state.customerEmail,
                    packageId: pkgId,
                    type: type,
                    priceId: priceId
                });
        
                if (response.sessionId) {
                    const stripe = Stripe(CONFIG.STRIPE_PUBLIC_KEY);
                    await stripe.redirectToCheckout({ sessionId: response.sessionId });
                } else {
                    throw new Error(response.error || "Could not initiate purchase.");
                }
            } catch (e) {
                alert(e.message);
                btn.innerHTML = "Buy Now";
                btn.disabled = false;
            }
        }
        
        async function goToPortal() {
            // Show loading on the link
            const link = document.querySelector('#manage-membership-link a');
            const originalText = link.textContent;
            link.textContent = "Processing...";
        
            try {
                const response = await callAppsScript('createPortalLink', { email: state.customerEmail });
                if (response.success) {
                    alert("A secure link has been sent to your email (" + state.customerEmail + ") to manage your memberships.");
                } else {
                    throw new Error(response.error || "Could not process request.");
                }
            } catch (e) {
                alert(e.message);
            }
            
            link.textContent = originalText;
        }
        
        // Gift Cards
                // Run on page load to check for #giftcard
        window.addEventListener('load', function() {
            if (window.location.hash === '#giftcard') {
                showGiftCardModal(true); // true = isDirectLink
            }
        });


        function showGiftCardModal(isDirectLink = false) {
            // If direct link, we need to ask for their email in the modal
            const buyerContainer = document.getElementById('gc-buyer-email-container');
            const buyerInput = document.getElementById('gc-buyer-email-input');
            
            if (isDirectLink) {
                buyerContainer.classList.remove('hidden');
                buyerInput.required = true;
                state.customerEmail = ''; // Clear state to ensure modal email is used
            } else {
                // Normal flow: check main input
                const email = document.getElementById('customer-email').value;
                if(!email) { alert("Please enter your email first."); return; }
                state.customerEmail = email;
                
                buyerContainer.classList.add('hidden');
                buyerInput.required = false;
            }
        
            document.getElementById('giftcard-modal').classList.remove('hidden');
        }
        
        function closeGiftCardModal() {
            document.getElementById('giftcard-modal').classList.add('hidden');
            // Clear hash if closing
            if (window.location.hash === '#giftcard') {
                history.pushState("", document.title, window.location.pathname);
            }
        }
        
        async function purchaseGiftCard() {
            const amount = document.getElementById('gc-amount-input-modal').value;
            const isGift = document.getElementById('gc-is-gift').checked;
            const recipientEmail = document.getElementById('gc-recipient-email').value;
            const recipientName = document.getElementById('gc-recipient-name').value;
        
            // Determine buyer email
            let buyerEmail = state.customerEmail;
            const buyerInput = document.getElementById('gc-buyer-email-input');
            
            if (buyerInput && buyerInput.value) {
                buyerEmail = buyerInput.value;
            }
        
            if(!buyerEmail) { alert("Please enter your email."); return; }
            if(!amount || amount <= 0) { alert("Please enter a valid amount."); return; }
            if(isGift && !recipientEmail) { alert("Please enter the recipient's email."); return; }
        
            const btn = document.querySelector('#giftcard-modal .btn-primary');
            btn.innerHTML = "Processing...";
            btn.disabled = true;
        
            try {
                const response = await callAppsScript('createGiftCardSession', {
                    email: buyerEmail,
                    amount: amount,
                    recipientEmail: isGift ? recipientEmail : null,
                    recipientName: isGift ? recipientName : null
                });
        
                if (response.sessionId) {
                    const stripe = Stripe(CONFIG.STRIPE_PUBLIC_KEY);
                    await stripe.redirectToCheckout({ sessionId: response.sessionId });
                } else {
                    throw new Error(response.error || "Could not initiate purchase.");
                }
            } catch (e) {
                alert(e.message);
                btn.innerHTML = "Continue to Payment";
                btn.disabled = false;
            }
        }

        async function processPayment(payerEmail = null) {
            const btn = document.getElementById('checkout-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Processing...';
        
            const firstAppt = state.checkoutAppointments.find(a => a.id === state.checkoutSelected[0]);
            const payerName = firstAppt ? firstAppt.name : 'Customer';
        
            // Calculate Breakdown for Description
            const breakdown = calculateCheckoutBreakdown();
        
            const checkoutData = {
                appointments: state.checkoutSelected.map(id => state.checkoutAppointments.find(a => a.id === id)),
                subtotal: parseFloat(document.getElementById('checkout-subtotal').textContent.replace('$','')),
                total: state.checkoutTotal, // This is the actual charge amount
                manualOverride: state.manualOverride,
                discount: state.appliedDiscount,
                notes: document.getElementById('checkout-notes').value,
                payerEmail: payerEmail,
                payerName: payerName,
                breakdown: breakdown // Pass the detailed breakdown
            };
        
            try {
                const response = await callAppsScript('createCheckoutSession', checkoutData);
                
                if (response.sessionId) {
                    const stripe = Stripe(CONFIG.STRIPE_PUBLIC_KEY);
                    await stripe.redirectToCheckout({ sessionId: response.sessionId });
                } else if (response.error) {
                    throw new Error(response.error);
                } else {
                    throw new Error("Could not create payment session.");
                }
            } catch (error) {
                console.error(error);
                alert("Error initiating payment: " + error.message);
                btn.disabled = false;
                btn.innerHTML = 'Accept Payment';
            }
        }

        // ============================================
        // API COMMUNICATION
        // ============================================
async function callAppsScript(action, data = {}) {
    if (!CONFIG.APPS_SCRIPT_URL || CONFIG.APPS_SCRIPT_URL === 'zzzKEY NEEDED') {
        throw new Error('Apps Script URL not configured');
    }

    // Define sensitive actions
    const adminActions = [
        'getCustomers', 'saveCustomer', 'getCreditManagement', 'saveNewCredit', 
        'adjustCredit', 'getAppointments', 'getDailyAgenda', 'getCheckoutData', 
        'deductCreditsAndGC', 'acceptCash', 'createCheckoutSession',
        'saveService', 'deleteService', 'getQuestionsList', 'saveQuestion', 
        'deleteQuestion', 'getBookings', 'updateAppointment', 'cancelAppointment', 'getCustomerHistory'
    ];

    // SECURITY FIX: Handle Password Injection
    if (action === 'checkPassword') {
        // Use the password passed in for the login action
        // Do nothing extra here, data.password is already set
    } else if (adminActions.includes(action)) {
        // For admin actions, use the memory variable
        if (!currentAdminPassword) {
            // Force back to login
            document.getElementById('business-portal').classList.add('hidden');
            document.getElementById('customer-booking').classList.remove('hidden');
            showBusinessLogin(); // Prompt login again
            throw new Error("Session expired. Please log in again.");
        }
        data.password = currentAdminPassword; 
    }

    try {
        const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({ action, ...data })
        });

        const text = await response.text();
        
        if (text.startsWith("<!DOCTYPE") || text.startsWith("<html")) {
            throw new Error("Server error. Try refreshing.");
        }

        const jsonData = JSON.parse(text);

        if (jsonData.error) {
            throw new Error(jsonData.error);
        }

        return jsonData;

    } catch (error) {
        console.error("Network/Parsing Error:", error);
        throw error;
    }
}

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date for checkout
            const today = new Date();
            document.getElementById('checkout-date').value = today.toISOString().split('T')[0];
        });
        
        // Allow enter to submit
    document.getElementById('customer-email').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            checkEmail();
        }
    });    
    </script>
    <div>
        <div onclick="showBusinessLogin()" class="admin-link">
            Admin
        </div>
    </div>
</body>

</html>






















